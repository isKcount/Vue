<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.51" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://vuepress-theme-hope-docs-demo.netlify.app/zh/isKcount/2/CKS/04.%E6%9C%80%E5%B0%8F%E5%8C%96%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%BC%8F%E6%B4%9E.html"><meta property="og:site_name" content="æ–‡æ¡£æ¼”ç¤º"><meta property="og:title" content="æœ€å°åŒ–å¾®æœåŠ¡æ¼æ´"><meta property="og:type" content="article"><meta property="og:updated_time" content="2022-10-11T05:08:11.000Z"><meta property="og:locale" content="zh-CN"><meta property="article:published_time" content="2022-04-15T15:13:20.000Z"><meta property="article:modified_time" content="2022-10-11T05:08:11.000Z"><link rel="icon" href="/favicon.ico"><link rel="icon" href="/assets/icon/chrome-mask-512.png" type="image/png" sizes="512x512"><link rel="icon" href="/assets/icon/chrome-mask-192.png" type="image/png" sizes="192x192"><link rel="icon" href="/assets/icon/chrome-512.png" type="image/png" sizes="512x512"><link rel="icon" href="/assets/icon/chrome-192.png" type="image/png" sizes="192x192"><link rel="manifest" href="/manifest.webmanifest" crossorigin="use-credentials"><meta name="theme-color" content="#46bd87"><link rel="apple-touch-icon" href="/assets/icon/apple-icon-152.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="msapplication-TileImage" content="/assets/icon/ms-icon-144.png"><meta name="msapplication-TileColor" content="#ffffff"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"><title>æœ€å°åŒ–å¾®æœåŠ¡æ¼æ´ | æ–‡æ¡£æ¼”ç¤º</title><meta name="description" content="vuepress-theme-hope çš„æ–‡æ¡£æ¼”ç¤º">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d2025;
      }

      html,
      body {
        background-color: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="stylesheet" href="/assets/style.7cb9ac72.css">
    <link rel="modulepreload" href="/assets/app.85823306.js"><link rel="modulepreload" href="/assets/04.æœ€å°åŒ–å¾®æœåŠ¡æ¼æ´.html.93c926dc.js"><link rel="modulepreload" href="/assets/_plugin-vue_export-helper.cdc0426e.js"><link rel="modulepreload" href="/assets/04.æœ€å°åŒ–å¾®æœåŠ¡æ¼æ´.html.8f7011c9.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">Skip to content</a><!--]--><div class="theme-container has-toc"><!--[--><!--[--><header class="navbar"><div class="navbar-left"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!----><a href="/zh" class="brand"><img class="logo" src="/logo.svg" alt="æ–‡æ¡£æ¼”ç¤º"><!----><span class="site-name hide-in-pad">æ–‡æ¡£æ¼”ç¤º</span></a><!----></div><div class="navbar-center"><!----><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/zh" class="nav-link" aria-label="isKcount"><span class="icon iconfont icon-home"></span>isKcount<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="åˆ†ç±»"><span class="title"><span class="icon iconfont icon-interact"></span>åˆ†ç±»</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/zh/isKcount/1/" class="nav-link" aria-label="å­¦ä¹ è·¯çº¿è§„åˆ’"><span class="icon iconfont icon-ability"></span>å­¦ä¹ è·¯çº¿è§„åˆ’<!----></a></li><li class="dropdown-item"><a href="/zh/isKcount/2/" class="nav-link active" aria-label="è€ƒè¯"><span class="icon iconfont icon-relation"></span>è€ƒè¯<!----></a></li><li class="dropdown-item"><a href="/zh/isKcount/3/" class="nav-link" aria-label="è¿ç»´ç¬”è®°"><span class="icon iconfont icon-linux"></span>è¿ç»´ç¬”è®°<!----></a></li><li class="dropdown-item"><a href="/zh/isKcount/4/" class="nav-link" aria-label="åç«¯å¼€å‘ç¬”è®°"><span class="icon iconfont icon-note"></span>åç«¯å¼€å‘ç¬”è®°<!----></a></li><li class="dropdown-item"><a href="/zh/isKcount/5/" class="nav-link" aria-label="å‰ç«¯å¼€å‘ç¬”è®°"><span class="icon iconfont icon-like"></span>å‰ç«¯å¼€å‘ç¬”è®°<!----></a></li><li class="dropdown-item"><a href="/zh/isKcount/6/" class="nav-link" aria-label="ä¸­é—´ä»¶æœåŠ¡ç¬”è®°"><span class="icon iconfont icon-api"></span>ä¸­é—´ä»¶æœåŠ¡ç¬”è®°<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Devops"><span class="title"><span class="icon iconfont icon-select"></span>Devops</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/zh/cicd/git/" class="nav-link" aria-label="Gitå¼€å‘æ‰‹å†Œ"><span class="icon iconfont icon-git"></span>Gitå¼€å‘æ‰‹å†Œ<!----></a></li><li class="dropdown-item"><a href="/zh/cicd/ci/" class="nav-link" aria-label="CICD"><span class="icon iconfont icon-ci"></span>CICD<!----></a></li><li class="dropdown-item"><a href="/zh/cicd/istio/" class="nav-link" aria-label="Istio"><span class="icon iconfont icon-material"></span>Istio<!----></a></li><li class="dropdown-item"><a href="/zh/cicd/operator/" class="nav-link" aria-label="Operator"><span class="icon iconfont icon-proxy"></span>Operator<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><a href="https://wallhaven.cc/" rel="noopener noreferrer" target="_blank" aria-label="Wallhaven" class="nav-link"><span class="icon iconfont icon-autumn"></span>Wallhaven<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div></nav><!----></div><div class="navbar-right"><!----><!----><div class="nav-item"><a class="repo-link" href="https://github.com/vuepress-theme-hope/vuepress-theme-hope" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button class="outlook-button" tabindex="-1" ariahidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="outlook-dropdown"><!----></div></button></div><form class="search-box" role="search"><input type="search" placeholder="æœç´¢" autocomplete="off" spellcheck="false" value><!----></form><!----><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow left"></span></div><aside class="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><!--[--><a href="/zh/isKcount/" class="nav-link sidebar-link sidebar-page" aria-label="æŒ‡å—"><span class="icon iconfont icon-creative"></span>æŒ‡å—<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-ability"></span><span class="title">å­¦ä¹ è·¯çº¿è§„åˆ’</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-relation"></span><span class="title">è€ƒè¯</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-linux"></span><span class="title">è¿ç»´ç¬”è®°</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-note"></span><span class="title">åç«¯å¼€å‘ç¬”è®°</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-like"></span><span class="title">å‰ç«¯å¼€å‘ç¬”è®°</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-api"></span><span class="title">ä¸­é—´ä»¶æœåŠ¡ç¬”è®°</span><span class="arrow right"></span></button><!----></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->æœ€å°åŒ–å¾®æœåŠ¡æ¼æ´</h1><div class="page-info"><span class="author-info" aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="author-item" href="https://iskcount.github.io" target="_blank" rel="noopener noreferrer">isKcount</a></span><span property="author" content="isKcount"></span></span><!----><span class="date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span>2022å¹´4æœˆ15æ—¥</span><meta property="datePublished" content="2022-04-15T15:13:20.000Z"></span><!----><!----><span class="reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 15 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT15M"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><div class="toc-header">æ­¤é¡µå†…å®¹</div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/zh/isKcount/2/CKS/04.%E6%9C%80%E5%B0%8F%E5%8C%96%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%BC%8F%E6%B4%9E.html#ä¸»è¦å†…å®¹" class="router-link-active router-link-exact-active toc-link level3">ä¸»è¦å†…å®¹</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zh/isKcount/2/CKS/04.%E6%9C%80%E5%B0%8F%E5%8C%96%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%BC%8F%E6%B4%9E.html#podå®‰å…¨ä¸Šä¸‹æ–‡" class="router-link-active router-link-exact-active toc-link level3">Podå®‰å…¨ä¸Šä¸‹æ–‡</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zh/isKcount/2/CKS/04.%E6%9C%80%E5%B0%8F%E5%8C%96%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%BC%8F%E6%B4%9E.html#æ¡ˆä¾‹å®æ–½" class="router-link-active router-link-exact-active toc-link level3">æ¡ˆä¾‹å®æ–½</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zh/isKcount/2/CKS/04.%E6%9C%80%E5%B0%8F%E5%8C%96%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%BC%8F%E6%B4%9E.html#podå®‰å…¨ç­–ç•¥-psp" class="router-link-active router-link-exact-active toc-link level3">Podå®‰å…¨ç­–ç•¥ï¼ˆPSPï¼‰</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zh/isKcount/2/CKS/04.%E6%9C%80%E5%B0%8F%E5%8C%96%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%BC%8F%E6%B4%9E.html#æ¡ˆä¾‹å®æ–½-1" class="router-link-active router-link-exact-active toc-link level3">æ¡ˆä¾‹å®æ–½</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zh/isKcount/2/CKS/04.%E6%9C%80%E5%B0%8F%E5%8C%96%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%BC%8F%E6%B4%9E.html#opa-gatekeeper" class="router-link-active router-link-exact-active toc-link level3">OPA Gatekeeper</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zh/isKcount/2/CKS/04.%E6%9C%80%E5%B0%8F%E5%8C%96%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%BC%8F%E6%B4%9E.html#æ¡ˆä¾‹å®æ–½-2" class="router-link-active router-link-exact-active toc-link level3">æ¡ˆä¾‹å®æ–½</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zh/isKcount/2/CKS/04.%E6%9C%80%E5%B0%8F%E5%8C%96%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%BC%8F%E6%B4%9E.html#secretå­˜å‚¨æ•æ„Ÿæ•°æ®" class="router-link-active router-link-exact-active toc-link level3">Secretå­˜å‚¨æ•æ„Ÿæ•°æ®</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zh/isKcount/2/CKS/04.%E6%9C%80%E5%B0%8F%E5%8C%96%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%BC%8F%E6%B4%9E.html#æ¡ˆä¾‹å®æ–½-3" class="router-link-active router-link-exact-active toc-link level3">æ¡ˆä¾‹å®æ–½</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zh/isKcount/2/CKS/04.%E6%9C%80%E5%B0%8F%E5%8C%96%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%BC%8F%E6%B4%9E.html#å®‰å…¨æ²™ç®±è¿è¡Œå®¹å™¨" class="router-link-active router-link-exact-active toc-link level3">å®‰å…¨æ²™ç®±è¿è¡Œå®¹å™¨</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zh/isKcount/2/CKS/04.%E6%9C%80%E5%B0%8F%E5%8C%96%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%BC%8F%E6%B4%9E.html#æ¡ˆä¾‹å®æ–½-4" class="router-link-active router-link-exact-active toc-link level3">æ¡ˆä¾‹å®æ–½</a></li><!----><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><h1 id="æœ€å°åŒ–å¾®æœåŠ¡æ¼æ´" tabindex="-1"><a class="header-anchor" href="#æœ€å°åŒ–å¾®æœåŠ¡æ¼æ´" aria-hidden="true">#</a> æœ€å°åŒ–å¾®æœåŠ¡æ¼æ´</h1><h3 id="ä¸»è¦å†…å®¹" tabindex="-1"><a class="header-anchor" href="#ä¸»è¦å†…å®¹" aria-hidden="true">#</a> ä¸»è¦å†…å®¹</h3><p>â– Podå®‰å…¨ä¸Šä¸‹æ–‡</p><p>â– Podå®‰å…¨ç­–ç•¥</p><p>â– Secretå­˜å‚¨æ•æ„Ÿæ•°æ®</p><p>â– å®‰å…¨æ²™ç®±è¿è¡Œå®¹å™¨</p><h3 id="podå®‰å…¨ä¸Šä¸‹æ–‡" tabindex="-1"><a class="header-anchor" href="#podå®‰å…¨ä¸Šä¸‹æ–‡" aria-hidden="true">#</a> Podå®‰å…¨ä¸Šä¸‹æ–‡</h3><p><code>å®‰å…¨ä¸Šä¸‹æ–‡ï¼ˆSecurity Contextï¼‰</code>ï¼šK8så¯¹Podå’Œå®¹å™¨æä¾›çš„å®‰å…¨æœºåˆ¶ï¼Œå¯ä»¥è®¾ç½®Podç‰¹æƒå’Œè®¿é—®æ§åˆ¶ã€‚</p><p><strong>å®‰å…¨ä¸Šä¸‹æ–‡é™åˆ¶ç»´åº¦ï¼š</strong></p><ul><li><code>è‡ªä¸»è®¿é—®æ§åˆ¶ï¼ˆDiscretionary Access Controlï¼‰</code>ï¼šåŸºäºç”¨æˆ·IDï¼ˆUIDï¼‰å’Œç»„IDï¼ˆGIDï¼‰ï¼Œæ¥åˆ¤å®šå¯¹å¯¹è±¡ï¼ˆä¾‹å¦‚æ–‡ä»¶ï¼‰ çš„è®¿é—®æƒé™ã€‚</li><li><code>å®‰å…¨æ€§å¢å¼ºçš„ Linuxï¼ˆSELinuxï¼‰</code>ï¼š ä¸ºå¯¹è±¡èµ‹äºˆå®‰å…¨æ€§æ ‡ç­¾ã€‚</li><li>ä»¥<code>ç‰¹æƒæ¨¡å¼</code>æˆ–è€…éç‰¹æƒæ¨¡å¼è¿è¡Œã€‚</li><li><code>Linux Capabilities</code>: ä¸ºè¿›ç¨‹èµ‹äºˆ root ç”¨æˆ·çš„éƒ¨åˆ†ç‰¹æƒè€Œéå…¨éƒ¨ç‰¹æƒã€‚</li><li><code>AppArmor</code>ï¼šå®šä¹‰Podä½¿ç”¨AppArmoré™åˆ¶å®¹å™¨å¯¹èµ„æºè®¿é—®é™åˆ¶</li><li><code>Seccomp</code>ï¼šå®šä¹‰Podä½¿ç”¨Seccompé™åˆ¶å®¹å™¨è¿›ç¨‹çš„ç³»ç»Ÿè°ƒç”¨</li><li><code>AllowPrivilegeEscalation</code>ï¼š ç¦æ­¢å®¹å™¨ä¸­è¿›ç¨‹ï¼ˆé€šè¿‡ SetUID æˆ– SetGID æ–‡ä»¶æ¨¡å¼ï¼‰è·å¾—ç‰¹æƒæå‡ã€‚å½“å®¹å™¨ä»¥ç‰¹æƒæ¨¡å¼ è¿è¡Œæˆ–è€…å…·æœ‰CAP_SYS_ADMINèƒ½åŠ›æ—¶ï¼ŒAllowPrivilegeEscalationæ€»ä¸ºTrueã€‚</li><li><code>readOnlyRootFilesystem</code>ï¼šä»¥åªè¯»æ–¹å¼åŠ è½½å®¹å™¨çš„æ ¹æ–‡ä»¶ç³»ç»Ÿã€‚</li></ul><h3 id="æ¡ˆä¾‹å®æ–½" tabindex="-1"><a class="header-anchor" href="#æ¡ˆä¾‹å®æ–½" aria-hidden="true">#</a> æ¡ˆä¾‹å®æ–½</h3><h5 id="æ¡ˆä¾‹1-è®¾ç½®å®¹å™¨ä»¥æ™®é€šç”¨æˆ·è¿è¡Œ" tabindex="-1"><a class="header-anchor" href="#æ¡ˆä¾‹1-è®¾ç½®å®¹å™¨ä»¥æ™®é€šç”¨æˆ·è¿è¡Œ" aria-hidden="true">#</a> æ¡ˆä¾‹1ï¼šè®¾ç½®å®¹å™¨ä»¥æ™®é€šç”¨æˆ·è¿è¡Œ</h5><p>èƒŒæ™¯ï¼šå®¹å™¨ä¸­çš„åº”ç”¨ç¨‹åºé»˜è®¤ä»¥rootè´¦å·è¿è¡Œçš„ï¼Œè¿™ä¸ªrootä¸å®¿ä¸»æœºrootè´¦å·æ˜¯ç›¸åŒçš„ï¼Œ æ‹¥æœ‰å¤§éƒ¨åˆ†å¯¹Linuxå†…æ ¸çš„ç³»ç»Ÿè°ƒç”¨æƒé™ï¼Œè¿™æ ·æ˜¯ä¸å®‰å…¨çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”è¯¥å°†å®¹å™¨ä»¥æ™® é€šç”¨æˆ·è¿è¡Œï¼Œå‡å°‘åº”ç”¨ç¨‹åºå¯¹æƒé™çš„ä½¿ç”¨ã€‚</p><p>å¯ä»¥é€šè¿‡ä¸¤ç§æ–¹æ³•è®¾ç½®æ™®é€šç”¨æˆ·ï¼š</p><ol><li>Dockerfileé‡Œä½¿ç”¨USERæŒ‡å®šè¿è¡Œç”¨æˆ·</li><li>K8sé‡ŒæŒ‡å®šspec.securityContext.runAsUserï¼ŒæŒ‡å®šå®¹å™¨é»˜è®¤ç”¨æˆ·UID</li></ol><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
    <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">1000</span> 	<span class="token comment"># é•œåƒé‡Œå¿…é¡»æœ‰è¿™ä¸ªç”¨æˆ·UID</span>
    <span class="token key atrule">fsGroup</span><span class="token punctuation">:</span> <span class="token number">1000</span> 		<span class="token comment"># æ•°æ®å·æŒ‚è½½åçš„ç›®å½•å±ç»„è®¾ç½®ä¸ºè¯¥ç»„</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> lizhenliang/flask<span class="token punctuation">-</span>demo<span class="token punctuation">:</span>root
    <span class="token key atrule">name</span><span class="token punctuation">:</span> web
    <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
      <span class="token key atrule">allowPrivilegeEscalation</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># ä¸å…è®¸ææƒ</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åˆ›å»ºPodä½¿ç”¨å®‰å…¨ä¸Šä¸‹æ–‡æµ‹è¯•æ˜¯å¦æ”¹ä¸ºuuidè¿è¡Œå®¹å™¨:</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span><span class="token null important">~</span><span class="token punctuation">]</span> <span class="token comment"># cat pod-test.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> test
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
    <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">1000</span>
    <span class="token key atrule">fsGroup</span><span class="token punctuation">:</span> <span class="token number">1000</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> lizhenliang/flask<span class="token punctuation">-</span>demo<span class="token punctuation">:</span>root
    <span class="token key atrule">name</span><span class="token punctuation">:</span> test
    <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
      <span class="token key atrule">allowPrivilegeEscalation</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‰§è¡Œyamlä¹‹åè¿›å…¥å®¹å™¨æŸ¥çœ‹å½“å‰çš„uuidï¼š</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># kubectl exec -it test -- bash</span>
python@test:/data/www$ <span class="token function">id</span>
<span class="token assign-left variable">uid</span><span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">(</span>python<span class="token punctuation">)</span> <span class="token assign-left variable">gid</span><span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">(</span>python<span class="token punctuation">)</span> <span class="token assign-left variable">groups</span><span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">(</span>python<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="æ¡ˆä¾‹2-é¿å…ä½¿ç”¨ç‰¹æƒå®¹å™¨" tabindex="-1"><a class="header-anchor" href="#æ¡ˆä¾‹2-é¿å…ä½¿ç”¨ç‰¹æƒå®¹å™¨" aria-hidden="true">#</a> æ¡ˆä¾‹2ï¼šé¿å…ä½¿ç”¨ç‰¹æƒå®¹å™¨</h5><p>èƒŒæ™¯ï¼šå®¹å™¨ä¸­æœ‰äº›åº”ç”¨ç¨‹åºå¯èƒ½éœ€è¦è®¿é—®å®¿ä¸»æœºè®¾å¤‡ã€ä¿®æ”¹å†…æ ¸ç­‰éœ€æ±‚ï¼Œåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œ å®¹å™¨æ²¡è¿™ä¸ªæœ‰è¿™ä¸ªèƒ½åŠ›ï¼Œå› æ­¤è¿™æ—¶ä¼šè€ƒè™‘ç»™å®¹å™¨è®¾ç½®ç‰¹æƒæ¨¡å¼ã€‚</p><p>å¯ç”¨ç‰¹æƒæ¨¡å¼ï¼š</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">containers</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> lizhenliang/flask<span class="token punctuation">-</span>demo<span class="token punctuation">:</span>root
  <span class="token key atrule">name</span><span class="token punctuation">:</span> web
  <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
    <span class="token key atrule">privileged</span><span class="token punctuation">:</span> true / false 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>å¯ç”¨ç‰¹æƒæ¨¡å¼å°±æ„å‘³ç€ï¼Œä½ è¦ä¸ºå®¹å™¨æä¾›äº†è®¿é—®Linuxå†…æ ¸çš„æ‰€æœ‰èƒ½åŠ›ï¼Œè¿™æ˜¯å¾ˆå±é™©çš„ï¼Œ ä¸ºäº†å‡å°‘ç³»ç»Ÿè°ƒç”¨çš„ä¾›ç»™ï¼Œå¯ä»¥ä½¿ç”¨Capabilitiesä¸ºå®¹å™¨èµ‹äºˆä»…æ‰€éœ€çš„èƒ½åŠ›ã€‚</p></blockquote><p><code>Linux Capabilitiesï¼šCapabilities æ˜¯ä¸€ä¸ªå†…æ ¸çº§åˆ«çš„æƒé™</code>ï¼Œå®ƒå…è®¸å¯¹å†…æ ¸è°ƒç”¨æƒ é™è¿›è¡Œæ›´ç»†ç²’åº¦çš„æ§åˆ¶ï¼Œè€Œä¸æ˜¯ç®€å•åœ°ä»¥ root èº«ä»½èƒ½åŠ›æˆæƒã€‚ Capabilities åŒ…æ‹¬æ›´æ”¹æ–‡ä»¶æƒé™ã€æ§åˆ¶ç½‘ç»œå­ç³»ç»Ÿå’Œæ‰§è¡Œç³»ç»Ÿç®¡ç†ç­‰åŠŸèƒ½ã€‚åœ¨ securityContext ä¸­ï¼Œå¯ä»¥æ·»åŠ æˆ–åˆ é™¤ Capabilitiesï¼Œåšåˆ°å®¹å™¨ç²¾ç»†åŒ–æƒé™æ§åˆ¶ã€‚</p><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204141224069.png" alt="image-20220413084355164" loading="lazy"></p><h5 id="æ¡ˆä¾‹3-å–æ¶ˆæŒ‚è½½æ–‡ä»¶ç³»ç»Ÿ" tabindex="-1"><a class="header-anchor" href="#æ¡ˆä¾‹3-å–æ¶ˆæŒ‚è½½æ–‡ä»¶ç³»ç»Ÿ" aria-hidden="true">#</a> æ¡ˆä¾‹3ï¼šå–æ¶ˆæŒ‚è½½æ–‡ä»¶ç³»ç»Ÿ</h5><p>å®¹å™¨é»˜è®¤æ²¡æœ‰æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿèƒ½åŠ›ï¼Œæ·»åŠ SYS_ADMINå¢åŠ è¿™ä¸ªèƒ½åŠ›</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox 
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox
    <span class="token key atrule">name</span><span class="token punctuation">:</span> test
    <span class="token key atrule">command</span><span class="token punctuation">:</span> 
    <span class="token punctuation">-</span> sleep
    <span class="token punctuation">-</span> 24h
    <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
      <span class="token key atrule">capabilities</span><span class="token punctuation">:</span>
        <span class="token key atrule">add</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;SYS_ADMIN&quot;</span><span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åˆ›å»ºè¿›å…¥å®¹å™¨æµ‹è¯•æŒ‚è½½æƒé™ï¼š</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># kubectl exec -it  busybox -- sh</span>
/ <span class="token comment"># mount /data/ /tmp/</span>
mount: mounting /data/ on /tmp/ failed: Permission denied
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="æ¡ˆä¾‹4-åªè¯»æŒ‚è½½æƒé™" tabindex="-1"><a class="header-anchor" href="#æ¡ˆä¾‹4-åªè¯»æŒ‚è½½æƒé™" aria-hidden="true">#</a> æ¡ˆä¾‹4ï¼šåªè¯»æŒ‚è½½æƒé™</h5><p>åªè¯»æŒ‚è½½å®¹å™¨æ–‡ä»¶ç³»ç»Ÿï¼Œé˜²æ­¢æ¶æ„äºŒè¿›åˆ¶æ–‡ä»¶åˆ›å»º</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox
    <span class="token key atrule">name</span><span class="token punctuation">:</span> test
    <span class="token key atrule">command</span><span class="token punctuation">:</span> 
    <span class="token punctuation">-</span> sleep
    <span class="token punctuation">-</span> 24h
    <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
      <span class="token key atrule">readOnlyRootFilesystem</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åˆ›å»ºè¿›å…¥å®¹å™¨æµ‹è¯•æ–‡ä»¶æƒé™ï¼š</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># kubectl exec -it  busybox  -- sh</span>
/ <span class="token comment"># mkdir a</span>
mkdir: can<span class="token string">&#39;t create directory &#39;</span>a&#39;: Read-only <span class="token function">file</span> system
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="podå®‰å…¨ç­–ç•¥-psp" tabindex="-1"><a class="header-anchor" href="#podå®‰å…¨ç­–ç•¥-psp" aria-hidden="true">#</a> Podå®‰å…¨ç­–ç•¥ï¼ˆPSPï¼‰</h3><p><code>PodSecurityPolicyï¼ˆç®€ç§°PSPï¼‰</code>ï¼šKubernetesä¸­Podéƒ¨ç½²æ—¶é‡è¦çš„å®‰å…¨æ ¡éªŒæ‰‹æ®µï¼Œèƒ½å¤Ÿ æœ‰æ•ˆåœ°çº¦æŸåº”ç”¨è¿è¡Œæ—¶è¡Œä¸ºå®‰å…¨ã€‚ ä½¿ç”¨PSPå¯¹è±¡å®šä¹‰ä¸€ç»„Podåœ¨è¿è¡Œæ—¶å¿…é¡»éµå¾ªçš„æ¡ä»¶åŠç›¸å…³å­—æ®µçš„é»˜è®¤å€¼ï¼Œåªæœ‰Podæ»¡è¶³è¿™ äº›æ¡ä»¶æ‰ä¼šè¢«K8sæ¥å—ã€‚</p><h4 id="podå®‰å…¨ç­–ç•¥é™åˆ¶ç»´åº¦" tabindex="-1"><a class="header-anchor" href="#podå®‰å…¨ç­–ç•¥é™åˆ¶ç»´åº¦" aria-hidden="true">#</a> Podå®‰å…¨ç­–ç•¥é™åˆ¶ç»´åº¦</h4><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204141224517.png" alt="image-20220413100840633" loading="lazy"></p><h4 id="å¯ç”¨å‡†å…¥æ§åˆ¶å™¨" tabindex="-1"><a class="header-anchor" href="#å¯ç”¨å‡†å…¥æ§åˆ¶å™¨" aria-hidden="true">#</a> å¯ç”¨å‡†å…¥æ§åˆ¶å™¨</h4><p>Podå®‰å…¨ç­–ç•¥å®ç°ä¸ºä¸€ä¸ªå‡†å…¥æ§åˆ¶å™¨ï¼Œé»˜è®¤æ²¡æœ‰å¯ç”¨ï¼Œå½“å¯ç”¨åä¼šå¼ºåˆ¶å®æ–½ Podå®‰å…¨ç­–ç•¥ï¼Œæ²¡æœ‰æ»¡è¶³çš„Podå°†æ— æ³•åˆ›å»ºã€‚å› æ­¤ï¼Œå»ºè®®åœ¨å¯ç”¨PSPä¹‹å‰å…ˆæ·»åŠ  ç­–ç•¥å¹¶å¯¹å…¶æˆæƒã€‚</p><p>å¯ç”¨Podå®‰å…¨ç­–ç•¥ï¼š</p><blockquote><p>vi /etc/kubernetes/manifests/kube-apiserver.yaml ... --enable-admission-plugins=NodeRestriction,PodSecurityPolicy ... systemctl restart kubelet</p></blockquote><h4 id="å¦‚ä½•ä½¿ç”¨pspèµ„æº" tabindex="-1"><a class="header-anchor" href="#å¦‚ä½•ä½¿ç”¨pspèµ„æº" aria-hidden="true">#</a> å¦‚ä½•ä½¿ç”¨PSPèµ„æº</h4><p>ç”¨æˆ·ä½¿ç”¨SA ï¼ˆServiceAccountï¼‰åˆ›å»ºäº†ä¸€ä¸ªPodï¼Œ<code>K8sä¼šå…ˆéªŒè¯è¿™ä¸ªSAæ˜¯å¦ å¯ä»¥è®¿é—®PSPèµ„æºæƒé™</code>ï¼Œå¦‚æœå¯ä»¥è¿›ä¸€æ­¥éªŒè¯Podé…ç½®æ˜¯å¦æ»¡è¶³PSPè§„åˆ™ï¼Œä»» æ„ä¸€æ­¥ä¸æ»¡è¶³éƒ½ä¼šæ‹’ç»éƒ¨ç½²ã€‚</p><p>å› æ­¤ï¼Œéœ€è¦å®æ–½éœ€è¦æœ‰è¿™å‡ ç‚¹ï¼š</p><ol><li>åˆ›å»ºSAæœåŠ¡è´¦å·</li><li>è¯¥SAéœ€è¦å…·å¤‡åˆ›å»ºå¯¹åº”èµ„æºæƒé™ï¼Œä¾‹å¦‚åˆ›å»ºPodã€Deployment</li><li>SAä½¿ç”¨PSPèµ„æºæƒé™ï¼šåˆ›å»ºRoleï¼Œä½¿ç”¨PSPèµ„æºæƒé™ï¼Œå†å°†SAç»‘å®šRole</li></ol><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204141224319.png" alt="image-20220413102111236" style="zoom:80%;"><h3 id="æ¡ˆä¾‹å®æ–½-1" tabindex="-1"><a class="header-anchor" href="#æ¡ˆä¾‹å®æ–½-1" aria-hidden="true">#</a> æ¡ˆä¾‹å®æ–½</h3><h5 id="ç¤ºä¾‹1-ç¦æ­¢åˆ›å»ºç‰¹æƒæ¨¡å¼çš„pod" tabindex="-1"><a class="header-anchor" href="#ç¤ºä¾‹1-ç¦æ­¢åˆ›å»ºç‰¹æƒæ¨¡å¼çš„pod" aria-hidden="true">#</a> ç¤ºä¾‹1ï¼šç¦æ­¢åˆ›å»ºç‰¹æƒæ¨¡å¼çš„Pod</h5><p>åˆ›å»ºPodå®‰å…¨ç­–ç•¥èµ„æºå¦‚ä¸‹ï¼š</p><ul><li>ä¸å…è®¸ç‰¹æƒPod</li><li>è¿è¡ŒseLinuxçš„è§„åˆ™</li><li>æŒ‡å®šå®¹å™¨å¯åŠ¨çš„ç”¨æˆ·IDå’Œä¸»ç»„IDä½ä»»ä½•äººæˆ–è€…ç¦æ­¢æ²¡æŒ‡å®šæ™®é€šç”¨æˆ·è¿è¡Œçš„å®¹å™¨ï¼ˆrunAsUserï¼‰</li><li>å…è®¸ä½¿ç”¨æŒ‚è½½ç±»å‹æ•°æ®å·</li></ul><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span><span class="token null important">~</span><span class="token punctuation">]</span><span class="token comment"># cat psp.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> policy/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PodSecurityPolicy
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> psp<span class="token punctuation">-</span>example
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># ä¸å…è®¸ç‰¹æƒPod</span>
  <span class="token comment"># ä¸‹é¢æ˜¯ä¸€äº›å¿…è¦çš„å­—æ®µ</span>
  <span class="token key atrule">seLinux</span><span class="token punctuation">:</span>
    <span class="token key atrule">rule</span><span class="token punctuation">:</span> RunAsAny
  <span class="token key atrule">supplementalGroups</span><span class="token punctuation">:</span>
    <span class="token key atrule">rule</span><span class="token punctuation">:</span> RunAsAny
  <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span>
    <span class="token key atrule">rule</span><span class="token punctuation">:</span> RunAsAny   /  MustRunAsNonRoot
  <span class="token key atrule">fsGroup</span><span class="token punctuation">:</span>
    <span class="token key atrule">rule</span><span class="token punctuation">:</span> RunAsAny
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">&#39;*&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‰§è¡Œä¹‹åæŸ¥çœ‹å½“å‰çš„PSPèµ„æºæƒ…å†µï¼š</p><p>åœ¨åç»­çš„1.25ä¹‹åçš„ç‰ˆæœ¬é‡Œé¢ï¼Œå°†ä¼šå®Œå…¨åºŸå¼ƒPodå®‰å…¨ç­–ç•¥ï¼Œé‡‡ç”¨å®‰å…¨ä¸Šä¸‹æ–‡ çš„æ–¹å¼ã€‚</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f psp.yaml</span>
Warning: policy/v1beta1 PodSecurityPolicy is deprecated <span class="token keyword">in</span> v1.21+, unavailable <span class="token keyword">in</span> v1.25+
podsecuritypolicy.policy/psp-example created

<span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># kubectl get psp</span>
Warning: policy/v1beta1 PodSecurityPolicy is deprecated <span class="token keyword">in</span> v1.21+, unavailable <span class="token keyword">in</span> v1.25+
NAME          PRIV    CAPS   SELINUX    RUNASUSER   FSGROUP    SUPGROUP   READONLYROOTFS   VOLUMES
psp-example   <span class="token boolean">false</span>          RunAsAny   RunAsAny    RunAsAny   RunAsAny   <span class="token boolean">false</span>            *
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="ç¤ºä¾‹2-ç¦æ­¢åˆ›å»ºç‰¹æƒæ¨¡å¼æµç¨‹" tabindex="-1"><a class="header-anchor" href="#ç¤ºä¾‹2-ç¦æ­¢åˆ›å»ºç‰¹æƒæ¨¡å¼æµç¨‹" aria-hidden="true">#</a> ç¤ºä¾‹2ï¼šç¦æ­¢åˆ›å»ºç‰¹æƒæ¨¡å¼æµç¨‹</h5><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># åˆ›å»ºSA</span>
$ kubectl create serviceaccount aliang

<span class="token comment"># å°†SAç»‘å®šåˆ°ç³»ç»Ÿå†…ç½®Role</span>
$ kubectl create rolebinding aliang <span class="token parameter variable">--clusterrole</span><span class="token operator">=</span>edit <span class="token parameter variable">--serviceaccount</span><span class="token operator">=</span>default:aliang

<span class="token comment"># åˆ›å»ºä½¿ç”¨PSPæƒé™çš„Role</span>
$ kubectl create role psp:unprivileged <span class="token parameter variable">--verb</span><span class="token operator">=</span>use <span class="token parameter variable">--resource</span><span class="token operator">=</span>podsecuritypolicy --resource-name<span class="token operator">=</span>psp-example

<span class="token comment"># å°†SAç»‘å®šåˆ°Role</span>
$ kubectl create rolebinding aliang:psp:unprivileged <span class="token parameter variable">--role</span><span class="token operator">=</span>psp:unprivileged <span class="token parameter variable">--serviceaccount</span><span class="token operator">=</span>default:aliang

<span class="token comment"># åˆ›å»ºpodæµ‹è¯•</span>
$ kubectl <span class="token parameter variable">--as</span><span class="token operator">=</span>system:serviceaccount:default:psp-sa run nginx <span class="token parameter variable">--image</span><span class="token operator">=</span>nginx
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="opa-gatekeeper" tabindex="-1"><a class="header-anchor" href="#opa-gatekeeper" aria-hidden="true">#</a> OPA Gatekeeper</h3><h4 id="opaä»‹ç»" tabindex="-1"><a class="header-anchor" href="#opaä»‹ç»" aria-hidden="true">#</a> OPAä»‹ç»</h4><p>PSPä¸è¶³ä¸çŠ¶å†µï¼š</p><ul><li>å°†å†1.21ç‰ˆæœ¬å¼ƒç”¨PSPï¼Œåœ¨1.25ç‰ˆæœ¬åˆ é™¤PSP</li><li>ä»…æ”¯æŒPodç­–ç•¥</li><li>ä½¿ç”¨å¤æ‚ï¼Œæƒé™æ¨¡å‹å­˜åœ¨ç¼ºé™·ï¼Œæ§åˆ¶ä¸æ˜ç¡®</li></ul><p>ğŸ·ï¸<a href="https://kubernetes.io/blog/2021/04/06/podsecuritypolicy-deprecation-past-present-and-future/" target="_blank" rel="noopener noreferrer">å¼ƒç”¨æ–‡ç« <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>ğŸ·ï¸<a href="https://github.com/kubernetes/enhancements/issues/2579" target="_blank" rel="noopener noreferrer">æ›¿ä»£ææ¡ˆ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p><code>OPAï¼ˆOpen Policy Agentï¼‰</code>ï¼šæ˜¯ä¸€ä¸ªå¼€æºçš„ã€é€šç”¨ç­–ç•¥å¼•æ“ï¼Œå¯ä»¥å°†ç­–ç•¥ç¼–å†™ä¸ºä»£ç ã€‚æä¾› ä¸€ä¸ªç§é«˜çº§å£°æ˜æ€§è¯­è¨€-Regoæ¥ç¼–å†™ç­–ç•¥ï¼Œå¹¶æŠŠå†³ç­–è¿™ä¸€æ­¥éª¤ä»å¤æ‚çš„ä¸šåŠ¡é€»è¾‘ä¸­è§£è€¦å‡ºæ¥ã€‚</p><p>OPAå¯ä»¥ç”¨æ¥åšä»€ä¹ˆï¼Ÿ</p><ol><li>æ‹’ç»ä¸ç¬¦åˆæ¡ä»¶çš„YAMLéƒ¨ç½²</li><li>å…è®¸ä½¿ç”¨å“ªäº›ä»“åº“ä¸­çš„é•œåƒ</li><li>å…è®¸åœ¨å“ªä¸ªæ—¶é—´æ®µè®¿é—®ç³»ç»Ÿ</li><li>ç­‰...</li></ol><h4 id="opaå·¥ä½œæµç¨‹" tabindex="-1"><a class="header-anchor" href="#opaå·¥ä½œæµç¨‹" aria-hidden="true">#</a> OPAå·¥ä½œæµç¨‹</h4><p>Gatekeeper æ˜¯åŸºäº OPAçš„ä¸€ä¸ª Kubernetes ç­–ç•¥è§£å†³æ–¹æ¡ˆï¼Œå¯æ›¿ä»£PSPæˆ–è€…éƒ¨åˆ†RBACåŠŸèƒ½ã€‚</p><p>å½“åœ¨é›†ç¾¤ä¸­éƒ¨ç½²äº†Gatekeeperç»„ä»¶ï¼ŒAPIServeræ‰€æœ‰çš„åˆ›å»ºã€æ›´æ–°æˆ–è€…åˆ é™¤æ“ä½œéƒ½ä¼šè§¦å‘ Gatekeeperæ¥å¤„ç†ï¼Œå¦‚æœä¸æ»¡è¶³ç­–ç•¥åˆ™æ‹’ç»ã€‚</p><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204141223253.png" alt="image-20220413133253793" loading="lazy"></p><h4 id="éƒ¨ç½²opa-gatekeeper" tabindex="-1"><a class="header-anchor" href="#éƒ¨ç½²opa-gatekeeper" aria-hidden="true">#</a> éƒ¨ç½²OPA Gatekeeper</h4><p>Gatekeeperçš„ç­–ç•¥ç”±ä¸¤ä¸ªèµ„æºå¯¹è±¡ç»„æˆï¼š</p><ul><li><code>Template</code>ï¼šç­–ç•¥é€»è¾‘å®ç°çš„åœ°æ–¹ï¼Œä½¿ç”¨regoè¯­è¨€</li><li><code>Contsraint</code>ï¼šè´Ÿè´£Kubernetesèµ„æºå¯¹è±¡çš„è¿‡æ»¤æˆ–è€…ä¸ºTemplateæä¾›è¾“å…¥å‚æ•°</li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01:~/cks/opa<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/open-policy-agent/gatekeeper/release-3.7/deploy/gatekeeper.yaml</span>

<span class="token punctuation">[</span>root@master01:~/cks/opa<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n gatekeeper-system</span>
NAME                                             READY   STATUS    RESTARTS   AGE
gatekeeper-controller-manager-66f474f785-kn5fl   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          32s
gatekeeper-controller-manager-66f474f785-xgz7s   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          32s
gatekeeper-controller-manager-66f474f785-xxwdm   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          32s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="æ¡ˆä¾‹å®æ–½-2" tabindex="-1"><a class="header-anchor" href="#æ¡ˆä¾‹å®æ–½-2" aria-hidden="true">#</a> æ¡ˆä¾‹å®æ–½</h3><h5 id="æ¡ˆä¾‹1-ç¦æ­¢å®¹å™¨å¯ç”¨ç‰¹æƒ" tabindex="-1"><a class="header-anchor" href="#æ¡ˆä¾‹1-ç¦æ­¢å®¹å™¨å¯ç”¨ç‰¹æƒ" aria-hidden="true">#</a> æ¡ˆä¾‹1ï¼šç¦æ­¢å®¹å™¨å¯ç”¨ç‰¹æƒ</h5><ul><li>éœ€è¦åˆ›å»º<code>ConstraintTemplate</code>çš„èµ„æº</li><li>ä½¿ç”¨<code>rego</code>çš„è¯­è¨€ç¼–å†™å¯¹å¯ç”¨ç‰¹æƒçš„èµ„æºå‘å‡ºè­¦å‘Š</li><li>éœ€è¦æŒ‡å®šç±»å‹ä¸º<code>privileged</code>æ¨¡å¼</li></ul><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span>~/cks/opa<span class="token punctuation">]</span><span class="token comment"># cat privileged_tpl.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> templates.gatekeeper.sh/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConstraintTemplate
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> privileged
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">crd</span><span class="token punctuation">:</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">names</span><span class="token punctuation">:</span>
        <span class="token key atrule">kind</span><span class="token punctuation">:</span> privileged
  <span class="token key atrule">targets</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">target</span><span class="token punctuation">:</span> admission.k8s.gatekeeper.sh
      <span class="token key atrule">rego</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
        package admission
        violation[{&quot;msg&quot;: msg}] {  # å¦‚æœviolationä¸ºtrueè¯´æ˜è¿åçº¦æŸ
          containers = input.review.object.spec.template.spec.containers
          c_name := containers[0].name
          containers[0].securityContext.privileged # å¦‚æœè¿”å›falseæˆ–è€…æ²¡è·å–åˆ°å€¼è¯´æ˜é€šè¿‡
          msg := sprintf(&quot;æç¤ºï¼š&#39;%v&#39;å®¹å™¨ç¦æ­¢å¯ç”¨ç‰¹æƒï¼&quot;,[c_name])
        }</span>
        
<span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span>~/cks/opa<span class="token punctuation">]</span><span class="token comment"># kubectl get ConstraintTemplate</span>
NAME         AGE
privileged   32m
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åˆ›å»ºçº¦æŸã€å¦‚ä¸‹æ˜¯çº¦æŸèµ„æºç±»å‹ï¼š</p><ul><li>Deployment</li><li>DaemonSet</li><li>StatefulSet</li></ul><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span>~/cks/opa<span class="token punctuation">]</span><span class="token comment"># cat privileged_constraints.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> constraints.gatekeeper.sh/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> privileged
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> privileged
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">match</span><span class="token punctuation">:</span>  <span class="token comment"># åŒ¹é…çš„èµ„æº</span>
    <span class="token key atrule">kinds</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;apps&quot;</span><span class="token punctuation">]</span>
        <span class="token key atrule">kinds</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token string">&quot;Deployment&quot;</span>
        <span class="token punctuation">-</span> <span class="token string">&quot;DaemonSet&quot;</span>
        <span class="token punctuation">-</span> <span class="token string">&quot;StatefulSet&quot;</span>
        
<span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span>~/cks/opa<span class="token punctuation">]</span><span class="token comment"># kubectl get constraints</span>
NAME         AGE
privileged   31m
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åˆ›å»ºDeploymentå¼€å¯ç‰¹æƒæ¨¡å¼å†æ‰§è¡Œåˆ›å»ºä¼šå‘å‡ºè­¦å‘Šã€‚</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
          <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          
<span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span>~/cks/opa<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f deployment.yaml</span>
Error from server (<span class="token punctuation">[</span>privileged<span class="token punctuation">]</span> æç¤ºï¼š&#39;nginx&#39;å®¹å™¨ç¦æ­¢å¯ç”¨ç‰¹æƒï¼)<span class="token punctuation">:</span> <span class="token key atrule">error when creating &quot;dp.yaml&quot;</span><span class="token punctuation">:</span> <span class="token key atrule">admission webhook &quot;validation.gatekeeper.sh&quot; denied the request</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>privileged<span class="token punctuation">]</span> æç¤ºï¼š&#39;nginx&#39;å®¹å™¨ç¦æ­¢å¯ç”¨ç‰¹æƒï¼
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="æ¡ˆä¾‹2-åªå…è®¸ä½¿ç”¨ç‰¹å®šçš„é•œåƒä»“åº“" tabindex="-1"><a class="header-anchor" href="#æ¡ˆä¾‹2-åªå…è®¸ä½¿ç”¨ç‰¹å®šçš„é•œåƒä»“åº“" aria-hidden="true">#</a> æ¡ˆä¾‹2ï¼šåªå…è®¸ä½¿ç”¨ç‰¹å®šçš„é•œåƒä»“åº“</h5><ul><li>éœ€è¦åˆ›å»º<code>ConstraintTemplate</code>çš„èµ„æº</li><li>ä½¿ç”¨<code>rego</code>çš„è¯­è¨€ç¼–å†™å¯¹é•œåƒä»“åº“çš„ä¿¡ä»»</li><li>éœ€è¦æŒ‡å®šç±»å‹ä¸º<code>image-check</code>æ¨¡å¼</li></ul><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span>~/cks/opa<span class="token punctuation">]</span><span class="token comment"># cat   image-check_tpl.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> templates.gatekeeper.sh/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConstraintTemplate
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> image<span class="token punctuation">-</span>check
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">crd</span><span class="token punctuation">:</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">names</span><span class="token punctuation">:</span>
        <span class="token key atrule">kind</span><span class="token punctuation">:</span> image<span class="token punctuation">-</span>check
      <span class="token key atrule">validation</span><span class="token punctuation">:</span>
        <span class="token key atrule">openAPIV3Schema</span><span class="token punctuation">:</span>
          <span class="token key atrule">properties</span><span class="token punctuation">:</span>  <span class="token comment"># éœ€è¦æ»¡è¶³æ¡ä»¶çš„å‚æ•°</span>
            <span class="token key atrule">prefix</span><span class="token punctuation">:</span>
              <span class="token key atrule">type</span><span class="token punctuation">:</span> string
  <span class="token key atrule">targets</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">target</span><span class="token punctuation">:</span> admission.k8s.gatekeeper.sh
      <span class="token key atrule">rego</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
        package image
        violation[{&quot;msg&quot;: msg}] {
          containers = input.review.object.spec.template.spec.containers
          image := containers[0].image
          not startswith(image, input.parameters.prefix)
          msg := sprintf(&quot;æç¤ºï¼š&#39;%v&#39;é•œåƒåœ°å€ä¸åœ¨å¯ä¿¡ä»»ä»“åº“ï¼&quot;, [image])
        }</span>
        
<span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span>~/cks/opa<span class="token punctuation">]</span><span class="token comment"># kubectl get constrainttemplate</span>
NAME          AGE
image<span class="token punctuation">-</span>check   77s
privileged    35m
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œéœ€è¦é…ç½®ä¼ é€’OPAçš„å‚æ•°ä¸ºï¼š &quot;lizhenliang/&quot;</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span>~/cks/opa<span class="token punctuation">]</span><span class="token comment"># cat image-check_constraints.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> constraints.gatekeeper.sh/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> image<span class="token punctuation">-</span>check
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> image<span class="token punctuation">-</span>check
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token key atrule">kinds</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;apps&quot;</span><span class="token punctuation">]</span>
        <span class="token key atrule">kinds</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token string">&quot;Deployment&quot;</span>
        <span class="token punctuation">-</span> <span class="token string">&quot;DaemonSet&quot;</span>
        <span class="token punctuation">-</span> <span class="token string">&quot;StatefulSet&quot;</span>
  <span class="token key atrule">parameters</span><span class="token punctuation">:</span>  <span class="token comment"># ä¼ é€’ç»™opaçš„å‚æ•°</span>
    <span class="token key atrule">prefix</span><span class="token punctuation">:</span> <span class="token string">&quot;lizhenliang/&quot;</span>
    
<span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span>~/cks/opa<span class="token punctuation">]</span><span class="token comment"># kubectl get constraints</span>
NAME                                                AGE
image<span class="token punctuation">-</span>check.constraints.gatekeeper.sh/image<span class="token punctuation">-</span>check   77s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‰§è¡Œæµ‹è¯•æ—¶ä½¿ç”¨dockerå®˜æ–¹çš„é•œåƒä»“åº“ï¼š</p><ol><li><code>ç”±äºæˆ‘ä»¬å¼€å¯äº†é•œåƒä»“åº“çš„ä¿¡ä»» æ‰€ä»¥å¯¹dockerä»“åº“ä¸æ”¯æŒ</code></li><li><code>åªèƒ½ä»lizhenliangè¯¥ä»“åº“è¿›è¡Œæ‹‰å–é•œåƒ</code></li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01:~/cks/opa<span class="token punctuation">]</span><span class="token comment"># kubectl create deployment test --image=nginx</span>
error: failed to create deployment: admission webhook <span class="token string">&quot;validation.gatekeeper.sh&quot;</span> denied the request: <span class="token punctuation">[</span>image-check<span class="token punctuation">]</span> æç¤ºï¼š<span class="token string">&#39;nginx&#39;</span>é•œåƒåœ°å€ä¸åœ¨å¯ä¿¡ä»»ä»“åº“ï¼
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="secretå­˜å‚¨æ•æ„Ÿæ•°æ®" tabindex="-1"><a class="header-anchor" href="#secretå­˜å‚¨æ•æ„Ÿæ•°æ®" aria-hidden="true">#</a> Secretå­˜å‚¨æ•æ„Ÿæ•°æ®</h3><p>Secretæ˜¯ä¸€ä¸ªç”¨äºå­˜å‚¨æ•æ„Ÿæ•°æ®çš„èµ„æºï¼Œæ‰€æœ‰çš„æ•°æ®è¦ç»è¿‡base64ç¼–ç ï¼Œæ•°æ®å®é™…ä¼šå­˜å‚¨åœ¨K8sä¸­Etcdï¼Œ ç„¶åé€šè¿‡åˆ›å»ºPodæ—¶å¼•ç”¨è¯¥æ•°æ®ã€‚</p><p>åº”ç”¨åœºæ™¯ï¼šå‡­æ®</p><p>Podä½¿ç”¨secretæ•°æ®æœ‰ä¸¤ç§æ–¹å¼ï¼š</p><ul><li><code>å˜é‡æ³¨å…¥</code></li><li><code>æ•°æ®å·æŒ‚è½½</code></li></ul><h4 id="secretçš„ç±»å‹" tabindex="-1"><a class="header-anchor" href="#secretçš„ç±»å‹" aria-hidden="true">#</a> secretçš„ç±»å‹</h4><p>kubectl create secret æ”¯æŒä¸‰ç§æ•°æ®ç±»å‹ï¼š</p><ul><li>docker-registryï¼šå­˜å‚¨é•œåƒä»“åº“è®¤è¯ä¿¡æ¯</li><li>genericï¼šä»æ–‡ä»¶ã€ç›®å½•æˆ–è€…å­—ç¬¦ä¸²åˆ›å»ºï¼Œä¾‹å¦‚å­˜å‚¨ç”¨æˆ·åå¯†ç </li><li>tlsï¼šå­˜å‚¨è¯ä¹¦ï¼Œä¾‹å¦‚HTTPSè¯ä¹¦</li></ul><h4 id="secretçš„ä½¿ç”¨" tabindex="-1"><a class="header-anchor" href="#secretçš„ä½¿ç”¨" aria-hidden="true">#</a> secretçš„ä½¿ç”¨</h4><p>ä¸€ä¸ª Secret å¯ä»¥åŒ…å« Pod è®¿é—®æ•°æ®åº“æ‰€éœ€çš„ç”¨æˆ·å‡­è¯ã€‚ ä¾‹å¦‚ï¼Œç”±ç”¨æˆ·åå’Œå¯†ç ç»„æˆçš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ã€‚ ä½  å¯ä»¥åœ¨æœ¬åœ°è®¡ç®—æœºä¸Šï¼Œå°†ç”¨æˆ·åå­˜å‚¨åœ¨æ–‡ä»¶ <code>./username.txt</code> ä¸­ï¼Œå°†å¯†ç å­˜å‚¨åœ¨æ–‡ä»¶ <code>./password.txt</code> ä¸­ã€‚</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># echo -n &#39;admin&#39; &gt; username.txt</span>
<span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># echo -n &#39;1a2b3c4d&#39; &gt; password.txt</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>åœ¨è¿™äº›å‘½ä»¤ä¸­ï¼Œ -n æ ‡å¿—ç¡®ä¿ç”Ÿæˆçš„æ–‡ä»¶åœ¨æ–‡æœ¬æœ«å°¾ä¸åŒ…å«é¢å¤–çš„æ¢è¡Œç¬¦ã€‚ è¿™ä¸€ç‚¹å¾ˆé‡è¦ï¼Œå› ä¸ºå½“ kubectl è¯» å–æ–‡ä»¶å¹¶å°†å†…å®¹ç¼–ç ä¸º base64 å­—ç¬¦ä¸²æ—¶ï¼Œå¤šä½™çš„æ¢è¡Œç¬¦ä¹Ÿä¼šè¢«ç¼–ç ã€‚</p><p>kubectl create secret å‘½ä»¤å°†è¿™äº›æ–‡ä»¶æ‰“åŒ…æˆä¸€ä¸ª Secret å¹¶åœ¨ API æœåŠ¡å™¨ä¸Šåˆ›å»ºå¯¹è±¡ã€‚</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span><span class="token null important">~</span><span class="token punctuation">]</span><span class="token comment"># kubectl create secret generic db-user-pass --from-file=username.txt --from-file=password.txt</span>
secret/db<span class="token punctuation">-</span>user<span class="token punctuation">-</span>pass created

<span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span><span class="token null important">~</span><span class="token punctuation">]</span><span class="token comment"># kubectl get secrets db-user-pass -o yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">password.txt</span><span class="token punctuation">:</span> MWEyYjNjNGQ=
  <span class="token key atrule">username.txt</span><span class="token punctuation">:</span> YWRtaW4=
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token string">&quot;2022-04-13T06:43:03Z&quot;</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> db<span class="token punctuation">-</span>user<span class="token punctuation">-</span>pass
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
  <span class="token key atrule">resourceVersion</span><span class="token punctuation">:</span> <span class="token string">&quot;100098&quot;</span>
  <span class="token key atrule">uid</span><span class="token punctuation">:</span> 440fa829<span class="token punctuation">-</span>0135<span class="token punctuation">-</span>4ef2<span class="token punctuation">-</span>b8dc<span class="token punctuation">-</span>9f06f5a2f2a3
<span class="token key atrule">type</span><span class="token punctuation">:</span> Opaque
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="è§£ç -secret" tabindex="-1"><a class="header-anchor" href="#è§£ç -secret" aria-hidden="true">#</a> è§£ç  Secret</h4><p>è¦æŸ¥çœ‹åˆ›å»ºçš„ Secret çš„å†…å®¹ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># kubectl get secrets db-user-pass -o jsonpath=&#39;{.data}&#39;</span>
<span class="token punctuation">{</span><span class="token string">&quot;password.txt&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;MWEyYjNjNGQ=&quot;</span>,<span class="token string">&quot;username.txt&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;YWRtaW4=&quot;</span><span class="token punctuation">}</span>
<span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># echo &#39;MWEyYjNjNGQ=&#39; | base64 -d</span>
1a2b3c4d
<span class="token punctuation">[</span>root@master01:~<span class="token punctuation">]</span><span class="token comment"># echo &#39;YWRtaW4=&#39; | base64 -d</span>
admin
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="æ¡ˆä¾‹å®æ–½-3" tabindex="-1"><a class="header-anchor" href="#æ¡ˆä¾‹å®æ–½-3" aria-hidden="true">#</a> æ¡ˆä¾‹å®æ–½</h3><h5 id="ç¤ºä¾‹-å°†mysqlç”¨æˆ·å¯†ç ä¿å­˜åˆ°secretä¸­å­˜å‚¨" tabindex="-1"><a class="header-anchor" href="#ç¤ºä¾‹-å°†mysqlç”¨æˆ·å¯†ç ä¿å­˜åˆ°secretä¸­å­˜å‚¨" aria-hidden="true">#</a> ç¤ºä¾‹ï¼šå°†Mysqlç”¨æˆ·å¯†ç ä¿å­˜åˆ°Secretä¸­å­˜å‚¨</h5><p>åˆ›å»ºsecretï¼Œmysql-root-passwordçš„é”®å€¼æ˜¯1a2a3a4a</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span><span class="token null important">~</span><span class="token punctuation">]</span><span class="token comment"># kubectl create secret generic mysql --from-literal=mysql-root-password=1a2a3a4a</span>
secret/mysql created

<span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span><span class="token null important">~</span><span class="token punctuation">]</span><span class="token comment"># kubectl get secrets mysql -o yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">mysql-root-password</span><span class="token punctuation">:</span> MWEyYTNhNGE=
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token string">&quot;2022-04-13T07:06:21Z&quot;</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
  <span class="token key atrule">resourceVersion</span><span class="token punctuation">:</span> <span class="token string">&quot;102066&quot;</span>
  <span class="token key atrule">uid</span><span class="token punctuation">:</span> 3104256b<span class="token punctuation">-</span>5b46<span class="token punctuation">-</span>43a4<span class="token punctuation">-</span>85ed<span class="token punctuation">-</span>acc66be7ccba
<span class="token key atrule">type</span><span class="token punctuation">:</span> Opaque
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åˆ›å»ºPodæµ‹è¯•ï¼Œä½¿ç”¨envä»secretä¸­å¼•ç”¨å˜é‡</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span><span class="token null important">~</span><span class="token punctuation">]</span><span class="token comment"># cat pod.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">run</span><span class="token punctuation">:</span> mysql
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">nodeName</span><span class="token punctuation">:</span> master01
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span>  mysql<span class="token punctuation">:</span><span class="token number">5.6</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
    <span class="token key atrule">env</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_ROOT_PASSWORD
      <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
        <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
          <span class="token key atrule">key</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>root<span class="token punctuation">-</span>password
          
<span class="token punctuation">[</span>root@master01<span class="token punctuation">:</span><span class="token null important">~</span><span class="token punctuation">]</span><span class="token comment"># kubectl get pods</span>
NAME    READY   STATUS    RESTARTS   AGE
mysql   1/1     Running   0          21s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="å®‰å…¨æ²™ç®±è¿è¡Œå®¹å™¨" tabindex="-1"><a class="header-anchor" href="#å®‰å…¨æ²™ç®±è¿è¡Œå®¹å™¨" aria-hidden="true">#</a> å®‰å…¨æ²™ç®±è¿è¡Œå®¹å™¨</h3><h4 id="gvisorä»‹ç»" tabindex="-1"><a class="header-anchor" href="#gvisorä»‹ç»" aria-hidden="true">#</a> gVisorä»‹ç»</h4><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204141224780.png" alt="image-20220413152858652" style="zoom:80%;"><p>æ‰€çŸ¥ï¼Œå®¹å™¨çš„åº”ç”¨ç¨‹åºå¯ä»¥ç›´æ¥è®¿é—®Linuxå†…æ ¸çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå®¹å™¨åœ¨å®‰å…¨éš”ç¦»ä¸Šè¿˜æ˜¯æ¯”è¾ƒå¼±ï¼Œè™½ç„¶ å†…æ ¸åœ¨ä¸æ–­åœ°å¢å¼ºè‡ªèº«çš„å®‰å…¨ç‰¹æ€§ï¼Œä½†ç”±äºå†…æ ¸è‡ªèº«ä»£ç æç«¯å¤æ‚ï¼ŒCVE æ¼æ´å±‚å‡ºä¸ç©·ã€‚ æ‰€ä»¥è¦æƒ³å‡å°‘è¿™æ–¹é¢å®‰å…¨é£é™©ï¼Œå°±æ˜¯åšå¥½å®‰å…¨éš”ç¦»ï¼Œé˜»æ–­å®¹å™¨å†…ç¨‹åºå¯¹ç‰©ç†æœºå†…æ ¸çš„ä¾èµ–ã€‚ Googleå¼€æºçš„ä¸€ç§gVisorå®¹å™¨æ²™ç®±æŠ€æœ¯å°±æ˜¯é‡‡ç”¨è¿™ç§æ€è·¯ï¼ŒgVisoréš”ç¦»å®¹å™¨å†…åº”ç”¨å’Œå†…æ ¸ä¹‹é—´è®¿ é—®ï¼Œæä¾›äº†å¤§éƒ¨åˆ†Linuxå†…æ ¸çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå·§å¦™çš„å°†å®¹å™¨å†…è¿›ç¨‹çš„ç³»ç»Ÿè°ƒç”¨è½¬åŒ–ä¸ºå¯¹gVisorçš„è®¿é—®ã€‚</p><p>gVisorå…¼å®¹OCIï¼Œä¸Dockerå’ŒK8sæ— ç¼é›†æˆï¼Œå¾ˆæ–¹é¢ä½¿ç”¨ã€‚</p><p>é¡¹ç›®åœ°å€ï¼š<a href="https://github.com/google/gvisor" target="_blank" rel="noopener noreferrer">https://github.com/google/gvisor<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h4 id="gvisorå†…æ ¸äº¤äº’" tabindex="-1"><a class="header-anchor" href="#gvisorå†…æ ¸äº¤äº’" aria-hidden="true">#</a> gVisorå†…æ ¸äº¤äº’</h4><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204131554215.png" alt="image-20220413152923179" loading="lazy"></p><h4 id="gvisoræ¶æ„" tabindex="-1"><a class="header-anchor" href="#gvisoræ¶æ„" aria-hidden="true">#</a> gVisoræ¶æ„</h4><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204131554075.png" alt="image-20220413153011389" loading="lazy"></p><h4 id="gvisorä¸dockeré›†æˆ" tabindex="-1"><a class="header-anchor" href="#gvisorä¸dockeré›†æˆ" aria-hidden="true">#</a> gVisorä¸Dockeré›†æˆ</h4><p>gVisorå†…æ ¸è¦æ±‚ï¼š</p><p>Linux 3.17+ å¦‚æœç”¨çš„æ˜¯CentOS7åˆ™éœ€è¦å‡çº§å†…æ ¸ï¼ŒUbuntuä¸éœ€è¦ã€‚</p><p>CentOS7å†…æ ¸å‡çº§æ­¥éª¤ï¼š</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-2.el7.elrepo.noarch.rpm</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># yum --enablerepo=elrepo-kernel install kernel-ml-devel kernel-ml â€“y</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># grub2-set-default 0</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># reboot</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># uname -r</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># 5.17.2-1.el7.elrepo.x86_64</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>gVisoré›†æˆDockeré…ç½®</p><p>å‚è€ƒæ–‡æ¡£ï¼š<a href="https://gvisor.dev/docs/user_guide/install/" target="_blank" rel="noopener noreferrer">https://gvisor.dev/docs/user_guide/install/<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>å·²ç»æµ‹è¯•è¿‡çš„åº”ç”¨å’Œå·¥å…·ï¼š<a href="https://gvisor.dev/docs/user_guide/compatibility/" target="_blank" rel="noopener noreferrer">https://gvisor.dev/docs/user_guide/compatibility/<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token number">1</span>ã€å‡†å¤‡gVisoräºŒè¿›åˆ¶æ–‡ä»¶
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># sha512sum -c runsc.sha512</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># rm -f *.sha512</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># chmod a+x runsc </span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># chmod a+x containerd-shim-runsc-v1</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># mv runsc containerd-shim-runsc-v1 /usr/local/bin</span>

<span class="token number">2</span>ã€Dockeré…ç½®ä½¿ç”¨gVisor
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># runsc install # æŸ¥çœ‹åŠ çš„é…ç½®/etc/docker/daemon.json</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart docker</span>


ä½¿ç”¨runscè¿è¡Œå®¹å™¨ï¼š
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># docker run -d --runtime=runsc nginx</span>
ä½¿ç”¨dmesgéªŒè¯ï¼š
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># docker run --runtime=runsc -it nginx dmesg</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="gvisorä¸containerdé›†æˆ" tabindex="-1"><a class="header-anchor" href="#gvisorä¸containerdé›†æˆ" aria-hidden="true">#</a> gVisorä¸Containerdé›†æˆ</h4><p>å¦‚æœè¿™é‡Œæ˜¯Dockerçš„ç¯å¢ƒï¼Œéœ€è¦åˆ‡æ¢åˆ°Containerdå®¹å™¨å¼•æ“ã€‚</p><p>ä»ç„¶éœ€è¦å°†runsc ã€containerd-shim-runsc-v1å·¥å…·ç§»åˆ°/usr/local/binä¸‹é¢</p><p><strong>1.å‡†å¤‡é…ç½®</strong></p><p>å¼€å¯ipv4è·¯ç”±è½¬å‘é…ç½®ï¼Œé‡æ–°ç”Ÿæ•ˆç³»ç»Ÿé…ç½®</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># cat &gt; /etc/sysctl.d/99-kubernetes-cri.conf &lt;&lt; EOF</span>
net.bridge.bridge-nf-call-iptables <span class="token operator">=</span> <span class="token number">1</span>
net.ipv4.ip_forward <span class="token operator">=</span> <span class="token number">1</span>
net.bridge.bridge-nf-call-ip6tables <span class="token operator">=</span> <span class="token number">1</span>
EOF

<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># sysctl -system</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>2ã€å®‰è£…Containerd</strong></p><p>å¦‚æœé»˜è®¤å®‰è£…äº†docker-ceä¼šè‡ªåŠ¨å®‰è£…containerdçš„ä¾èµ–ï¼Œæ²¡æœ‰åˆ™éœ€è¦å®‰è£…containerdã€‚</p><p>ubuntuæ·»åŠ docker-ceçš„repoæºä¹‹åapt-get installçš„æ–¹å¼å®‰è£…</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># cd /etc/yum.repos.d</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># wget http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># yum install -y containerd.io</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>3ã€ä¿®æ”¹é…ç½®æ–‡ä»¶</strong></p><ol><li>pauseé•œåƒåœ°å€</li><li>Cgroupé©±åŠ¨æ”¹ä¸ºsystemd</li><li>å¢åŠ runscå®¹å™¨è¿è¡Œæ—¶</li><li>é…ç½®dockeré•œåƒåŠ é€Ÿå™¨</li></ol><p>ä¿®æ”¹é…ç½®æ–‡ä»¶é»˜è®¤çš„containerdçš„é…ç½®æ–‡ä»¶æ˜¯ç©ºçš„ï¼Œæ‰€ä»¥éœ€è¦é‡æ–°ç”Ÿæˆä¸€ä¸ªå®Œæ•´çš„é…ç½®æ–‡ä»¶ã€‚</p><p>containerdçš„ç›®å½•æ˜¯åœ¨ <code>/etc/containerd</code></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># cd /etc/containerd/</span>
<span class="token punctuation">[</span>root@master01 containerd<span class="token punctuation">]</span><span class="token comment"># containerd config  default &gt; config.toml</span>
<span class="token punctuation">[</span>root@master01 containerd<span class="token punctuation">]</span><span class="token comment"># vim config.toml</span>
 <span class="token number">43</span>   <span class="token punctuation">[</span>plugins.<span class="token string">&quot;io.containerd.grpc.v1.cri&quot;</span><span class="token punctuation">]</span>
 		Â·Â·Â·Â·
 		<span class="token comment"># ä¿®æ”¹é•œåƒä¸ºå›½å†…çš„é•œåƒ</span>
 <span class="token number">56</span>     sandbox_image <span class="token operator">=</span> <span class="token string">&quot;registry.aliyuncs.com/google_containers/pause:3.2&quot;</span>   
 		Â·Â·Â·Â· 
 			<span class="token comment"># æ·»åŠ ä¸€ä¸ªrunsc,æŒ‡å®šç±»å‹ä¸ºrunscï¼Œè¿™é‡Œæ˜¯è·ŸruncåŒçº§</span>
 <span class="token number">90</span>        <span class="token punctuation">[</span>plugins.<span class="token string">&quot;io.containerd.grpc.v1.cri&quot;</span>.containerd.runtimes.runsc<span class="token punctuation">]</span>  
 <span class="token number">91</span>           runtime_type <span class="token operator">=</span> <span class="token string">&quot;io.containerd.runsc.v1&quot;</span>   				  

			<span class="token comment"># ä¿®æ”¹systemdé©±åŠ¨ä¸ºtrue</span>
 <span class="token number">94</span>        <span class="token punctuation">[</span>plugins.<span class="token string">&quot;io.containerd.grpc.v1.cri&quot;</span>.containerd.runtimes.runc<span class="token punctuation">]</span>
 <span class="token number">103</span>          <span class="token punctuation">[</span>plugins.<span class="token string">&quot;io.containerd.grpc.v1.cri&quot;</span>.containerd.runtimes.runc.options<span class="token punctuation">]</span>
				Â·Â·Â·
 <span class="token number">114</span>            SystemdCgroup <span class="token operator">=</span> <span class="token boolean">true</span>	
 		
 			<span class="token comment"># æ·»åŠ dockerä»“åº“çš„é•œåƒæºï¼Œé…ç½®é˜¿é‡Œé•œåƒåŠ é€Ÿ</span>
 <span class="token number">139</span>       <span class="token punctuation">[</span>plugins.<span class="token string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.mirrors<span class="token punctuation">]</span>
 <span class="token number">140</span>        <span class="token punctuation">[</span>plugins.<span class="token string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.mirrors.<span class="token string">&quot;docker.io&quot;</span><span class="token punctuation">]</span>  
 <span class="token number">141</span>          endpoint <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;https://b9pmyelo.mirror.aliyuncs.com&quot;</span><span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>é…ç½®kubeletä½¿ç”¨containerd</strong></p><p>é…ç½®å®Œä¹‹åå…ˆé‡å¯containerdï¼Œå†é‡å¯kubeletï¼Œæœ€åå¦‚æœpodå‡ºç°æŠ¥é”™ï¼Œé‡å¯dockerã€‚</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># vi /etc/sysconfig/kubelet </span>
<span class="token assign-left variable">KUBELET_EXTRA_ARGS</span><span class="token operator">=</span>--container-runtime<span class="token operator">=</span>remote --container-runtime-endpoint<span class="token operator">=</span>unix:///run/containerd/containerd.sock --cgroup-driver<span class="token operator">=</span>systemd

<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart containerd</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart kubelet</span>
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart docker</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>éªŒè¯å½“å‰çš„Kuberneteså®¹å™¨åŸºå±‚</strong></p><ol><li><code>ä»¥ä¸Šçš„æ­¥éª¤éœ€è¦åœ¨æ‰€æœ‰é›†ç¾¤é…ç½®</code></li><li><code>åŒ…æ‹¬crictlè¿æ¥containerdçš„é…ç½®ä¹Ÿè¦åœ¨æ‰€æœ‰é›†ç¾¤è¿è¡Œ</code></li></ol><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get  node -o wide | awk  &#39;{print $1,$2,$5,$NF}&#39; | column -t</span>
NAME      STATUS  VERSION  CONTAINER-RUNTIME
master01  Ready   v1.22.1  containerd://1.5.11
master02  Ready   v1.22.1  containerd://1.5.11
master03  Ready   v1.22.1  containerd://1.5.11
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>crictlè¿æ¥containerd</strong></p><p>containerdä¹Ÿæœ‰ ctr ç®¡ç†å·¥å…·ï¼Œä½†åŠŸèƒ½æ¯”è¾ƒç®€å•ï¼Œä¸€èˆ¬ä½¿ç”¨crictlå·¥å…·æ£€æŸ¥å’Œè°ƒè¯•å®¹å™¨ã€‚</p><p>é¡¹ç›®åœ°å€ï¼š<a href="https://github.com/kubernetes-sigs/cri-tools/" target="_blank" rel="noopener noreferrer">https://github.com/kubernetes-sigs/cri-tools/<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>å‡†å¤‡crictlè¿æ¥containerdé…ç½®æ–‡ä»¶ï¼š</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># cat &gt; /etc/crictl.yaml &lt;&lt; EOF</span>
runtime-endpoint: unix:///run/containerd/containerd.sock
EOF
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># systemctl restart  containerd </span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸‹é¢æ˜¯dockerä¸crictlå‘½ä»¤å¯¹ç…§è¡¨ï¼š</p><p><img src="https://pic1.xuehuaimg.com/proxy/raw.githubusercontent.com/2756864799zhang/image/main/img/202204141224352.png" alt="image-20220414115021436" loading="lazy"></p><h3 id="æ¡ˆä¾‹å®æ–½-4" tabindex="-1"><a class="header-anchor" href="#æ¡ˆä¾‹å®æ–½-4" aria-hidden="true">#</a> æ¡ˆä¾‹å®æ–½</h3><h5 id="ç¤ºä¾‹-k8sä½¿ç”¨gvisorè¿è¡Œå®¹å™¨" tabindex="-1"><a class="header-anchor" href="#ç¤ºä¾‹-k8sä½¿ç”¨gvisorè¿è¡Œå®¹å™¨" aria-hidden="true">#</a> ç¤ºä¾‹ï¼š K8sä½¿ç”¨gVisorè¿è¡Œå®¹å™¨</h5><ul><li>åˆ›å»ºRuntimeClass</li><li>ç»‘å®šRuntimeClass</li></ul><p>RuntimeClass æ˜¯ä¸€ä¸ªç”¨äºé€‰æ‹©å®¹å™¨è¿è¡Œæ—¶é…ç½®çš„ç‰¹æ€§ï¼Œå®¹å™¨è¿è¡Œæ—¶é…ç½®ç”¨ äºè¿è¡Œ Pod ä¸­çš„å®¹å™¨ã€‚</p><p>åˆ›å»ºRuntimeClassï¼š</p><ul><li>è¿™é‡Œåˆ›å»ºä¸€ä¸ªåç§°ä¸º<code>gvisor</code>çš„runtimeclassèµ„æº</li><li>å¯ä»¥åˆ›å»ºå¤šä¸ª<code>runtimeclass</code>èµ„æºï¼Œèµ·åˆ°éš”ç¦»çš„æ•ˆæœ</li><li>handlerä¸€å®šæ˜¯<code>runsc</code>ï¼Œå¯¹åº”CSIçš„é…ç½®åç§°</li></ul><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># cat runtime.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> node.k8s.io/v1 <span class="token comment"># RuntimeClass å®šä¹‰äº node.k8s.io API ç»„</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> RuntimeClass
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> gvisor <span class="token comment"># ç”¨æ¥å¼•ç”¨ RuntimeClass çš„åå­—</span>
<span class="token key atrule">handler</span><span class="token punctuation">:</span> runsc <span class="token comment"># å¯¹åº”çš„ CRI é…ç½®çš„åç§°</span>

<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get runtimeclasses</span>
NAME     HANDLER   AGE
gvisor   runsc     72m
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åˆ›å»ºPodæµ‹è¯•gVisorï¼š</p><p>è¿™é‡Œä½¿ç”¨<code>runtimeClassName</code>ç»‘å®š</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># cat pod.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">run</span><span class="token punctuation">:</span> pod
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">nodeName</span><span class="token punctuation">:</span> <span class="token string">&quot;master01&quot;</span>
  <span class="token key atrule">runtimeClassName</span><span class="token punctuation">:</span> gvisor
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">name</span><span class="token punctuation">:</span> pod
    
<span class="token punctuation">[</span>root@master01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods</span>
NAME   READY   STATUS    RESTARTS   AGE
pod    1/1     Running   0          72m
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/vuepress-theme-hope/vuepress-theme-hope/edit/main/demo/theme-docs/src/zh/isKcount/2/CKS/04.æœ€å°åŒ–å¾®æœåŠ¡æ¼æ´.md" rel="noopener noreferrer" target="_blank" aria-label="åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item update-time"><span class="label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><!----></div><div class="meta-item contributors"><span class="label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="contributor" title="email: admin@example.com">Administrator</span><!--]--><!--]--></div></footer><!----><!----><!----><!--]--></main><!--]--><footer class="footer-wrapper"><div class="footer">é»˜è®¤é¡µè„š</div><div class="copyright">Copyright Â© 2022 isKcount</div></footer><!--]--></div><!--]--><!----><!----><!--]--></div>
    <script type="module" src="/assets/app.85823306.js" defer></script>
  </body>
</html>
