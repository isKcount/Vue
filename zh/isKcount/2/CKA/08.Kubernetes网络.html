<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.51" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://vuepress-theme-hope-docs-demo.netlify.app/zh/isKcount/2/CKA/08.Kubernetes%E7%BD%91%E7%BB%9C.html"><meta property="og:site_name" content="文档演示"><meta property="og:title" content="Kubernetes网络"><meta property="og:type" content="article"><meta property="og:updated_time" content="2022-10-11T05:08:11.000Z"><meta property="og:locale" content="zh-CN"><meta property="article:published_time" content="2022-01-22T12:12:06.000Z"><meta property="article:modified_time" content="2022-10-11T05:08:11.000Z"><link rel="icon" href="/favicon.ico"><link rel="icon" href="/assets/icon/chrome-mask-512.png" type="image/png" sizes="512x512"><link rel="icon" href="/assets/icon/chrome-mask-192.png" type="image/png" sizes="192x192"><link rel="icon" href="/assets/icon/chrome-512.png" type="image/png" sizes="512x512"><link rel="icon" href="/assets/icon/chrome-192.png" type="image/png" sizes="192x192"><link rel="manifest" href="/manifest.webmanifest" crossorigin="use-credentials"><meta name="theme-color" content="#46bd87"><link rel="apple-touch-icon" href="/assets/icon/apple-icon-152.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="msapplication-TileImage" content="/assets/icon/ms-icon-144.png"><meta name="msapplication-TileColor" content="#ffffff"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"><title>Kubernetes网络 | 文档演示</title><meta name="description" content="vuepress-theme-hope 的文档演示">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d2025;
      }

      html,
      body {
        background-color: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="stylesheet" href="/assets/style.7cb9ac72.css">
    <link rel="modulepreload" href="/assets/app.85823306.js"><link rel="modulepreload" href="/assets/08.Kubernetes网络.html.83fa8e7b.js"><link rel="modulepreload" href="/assets/_plugin-vue_export-helper.cdc0426e.js"><link rel="modulepreload" href="/assets/08.Kubernetes网络.html.b4abb2b3.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">Skip to content</a><!--]--><div class="theme-container has-toc"><!--[--><!--[--><header class="navbar"><div class="navbar-left"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!----><a href="/zh" class="brand"><img class="logo" src="/logo.svg" alt="文档演示"><!----><span class="site-name hide-in-pad">文档演示</span></a><!----></div><div class="navbar-center"><!----><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/zh" class="nav-link" aria-label="isKcount"><span class="icon iconfont icon-home"></span>isKcount<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="分类"><span class="title"><span class="icon iconfont icon-interact"></span>分类</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/zh/isKcount/1/" class="nav-link" aria-label="学习路线规划"><span class="icon iconfont icon-ability"></span>学习路线规划<!----></a></li><li class="dropdown-item"><a href="/zh/isKcount/2/" class="nav-link active" aria-label="考证"><span class="icon iconfont icon-relation"></span>考证<!----></a></li><li class="dropdown-item"><a href="/zh/isKcount/3/" class="nav-link" aria-label="运维笔记"><span class="icon iconfont icon-linux"></span>运维笔记<!----></a></li><li class="dropdown-item"><a href="/zh/isKcount/4/" class="nav-link" aria-label="后端开发笔记"><span class="icon iconfont icon-note"></span>后端开发笔记<!----></a></li><li class="dropdown-item"><a href="/zh/isKcount/5/" class="nav-link" aria-label="前端开发笔记"><span class="icon iconfont icon-like"></span>前端开发笔记<!----></a></li><li class="dropdown-item"><a href="/zh/isKcount/6/" class="nav-link" aria-label="中间件服务笔记"><span class="icon iconfont icon-api"></span>中间件服务笔记<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Devops"><span class="title"><span class="icon iconfont icon-select"></span>Devops</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/zh/cicd/git/" class="nav-link" aria-label="Git开发手册"><span class="icon iconfont icon-git"></span>Git开发手册<!----></a></li><li class="dropdown-item"><a href="/zh/cicd/ci/" class="nav-link" aria-label="CICD"><span class="icon iconfont icon-ci"></span>CICD<!----></a></li><li class="dropdown-item"><a href="/zh/cicd/istio/" class="nav-link" aria-label="Istio"><span class="icon iconfont icon-material"></span>Istio<!----></a></li><li class="dropdown-item"><a href="/zh/cicd/operator/" class="nav-link" aria-label="Operator"><span class="icon iconfont icon-proxy"></span>Operator<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><a href="https://wallhaven.cc/" rel="noopener noreferrer" target="_blank" aria-label="Wallhaven" class="nav-link"><span class="icon iconfont icon-autumn"></span>Wallhaven<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div></nav><!----></div><div class="navbar-right"><!----><!----><div class="nav-item"><a class="repo-link" href="https://github.com/vuepress-theme-hope/vuepress-theme-hope" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button class="outlook-button" tabindex="-1" ariahidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="outlook-dropdown"><!----></div></button></div><form class="search-box" role="search"><input type="search" placeholder="搜索" autocomplete="off" spellcheck="false" value><!----></form><!----><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow left"></span></div><aside class="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><!--[--><a href="/zh/isKcount/" class="nav-link sidebar-link sidebar-page" aria-label="指南"><span class="icon iconfont icon-creative"></span>指南<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-ability"></span><span class="title">学习路线规划</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-relation"></span><span class="title">考证</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-linux"></span><span class="title">运维笔记</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-note"></span><span class="title">后端开发笔记</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-like"></span><span class="title">前端开发笔记</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-api"></span><span class="title">中间件服务笔记</span><span class="arrow right"></span></button><!----></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->Kubernetes网络</h1><div class="page-info"><span class="author-info" aria-label="作者🖊" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="author-item" href="https://iskcount.github.io" target="_blank" rel="noopener noreferrer">isKcount</a></span><span property="author" content="isKcount"></span></span><!----><span class="date-info" aria-label="写作日期📅" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span>2022年1月22日</span><meta property="datePublished" content="2022-01-22T12:12:06.000Z"></span><!----><!----><span class="reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 13 分钟</span><meta property="timeRequired" content="PT13M"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><div class="toc-header">此页内容</div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/zh/isKcount/2/CKA/08.Kubernetes%E7%BD%91%E7%BB%9C.html#service" class="router-link-active router-link-exact-active toc-link level2">Service</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/zh/isKcount/2/CKA/08.Kubernetes%E7%BD%91%E7%BB%9C.html#service存在的意义" class="router-link-active router-link-exact-active toc-link level3">Service存在的意义</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zh/isKcount/2/CKA/08.Kubernetes%E7%BD%91%E7%BB%9C.html#pod与service的关系" class="router-link-active router-link-exact-active toc-link level3">Pod与Service的关系</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zh/isKcount/2/CKA/08.Kubernetes%E7%BD%91%E7%BB%9C.html#service的三种类型" class="router-link-active router-link-exact-active toc-link level3">Service的三种类型</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zh/isKcount/2/CKA/08.Kubernetes%E7%BD%91%E7%BB%9C.html#service代理模式" class="router-link-active router-link-exact-active toc-link level3">Service代理模式</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zh/isKcount/2/CKA/08.Kubernetes%E7%BD%91%E7%BB%9C.html#service-dns名称" class="router-link-active router-link-exact-active toc-link level3">Service DNS名称</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zh/isKcount/2/CKA/08.Kubernetes%E7%BD%91%E7%BB%9C.html#ingress" class="router-link-active router-link-exact-active toc-link level2">Ingress</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/zh/isKcount/2/CKA/08.Kubernetes%E7%BD%91%E7%BB%9C.html#ingress为弥补nodeport不足而生" class="router-link-active router-link-exact-active toc-link level3">Ingress为弥补NodePort不足而生</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zh/isKcount/2/CKA/08.Kubernetes%E7%BD%91%E7%BB%9C.html#ingress-controller" class="router-link-active router-link-exact-active toc-link level3">Ingress Controller</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zh/isKcount/2/CKA/08.Kubernetes%E7%BD%91%E7%BB%9C.html#环境准备" class="router-link-active router-link-exact-active toc-link level3">环境准备</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zh/isKcount/2/CKA/08.Kubernetes%E7%BD%91%E7%BB%9C.html#ingress-1" class="router-link-active router-link-exact-active toc-link level3">Ingress</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/zh/isKcount/2/CKA/08.Kubernetes%E7%BD%91%E7%BB%9C.html#ingress配置https的加密认证" class="router-link-active router-link-exact-active toc-link level3">Ingress配置https的加密认证</a></li><!----><!--]--></ul><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><h1 id="kubernetes网络" tabindex="-1"><a class="header-anchor" href="#kubernetes网络" aria-hidden="true">#</a> Kubernetes网络</h1><h2 id="service" tabindex="-1"><a class="header-anchor" href="#service" aria-hidden="true">#</a> Service</h2><h3 id="service存在的意义" tabindex="-1"><a class="header-anchor" href="#service存在的意义" aria-hidden="true">#</a> Service存在的意义</h3><ul><li><p>service是k8s中的一个重要概念，主要是提供负载均衡和服务</p></li><li><p>防止Pod失联</p></li><li><p>定义一组Pod的访问策略</p></li><li><p>为了解决以下两个问题，K8s引入Service</p></li><li><p><strong>Pod的IP不固定：</strong></p><ul><li><strong>增加一个控制器负责动态获取Pod的列表IP，动态更新到负载均衡器配置。</strong></li></ul></li><li><p><strong>Pod是多副本</strong></p><ul><li><strong>前面增加一个负载均衡器</strong></li></ul></li></ul><h3 id="pod与service的关系" tabindex="-1"><a class="header-anchor" href="#pod与service的关系" aria-hidden="true">#</a> Pod与Service的关系</h3><ul><li><p>通过label-selector相关联</p></li><li><p>通过Service实现Pod的负载均衡（TCP/UDP 4层）</p></li></ul><h3 id="service的三种类型" tabindex="-1"><a class="header-anchor" href="#service的三种类型" aria-hidden="true">#</a> Service的三种类型</h3><ul><li><p><strong>ClusterIP：集群内部使用</strong></p></li><li><p><strong>NodePort：对外暴露应用</strong></p></li><li><p><strong>LoadBalancer：对外暴露应用，适用公有云</strong></p></li><li><p><code>ClusterIP</code>：默认，分配一个稳定的IP地址，即VIP，只能在集群内 部访问（同Namespace内的Pod）。</p></li><li><p><code>NodePort</code>：在每个节点上启用一个端口来暴露服务，可以在集群 外部访问。也会分配一个稳定内部集群IP地址。 访问地址：: 端口范围：30000-32767。</p></li><li><p><code>LoadBalancer</code>：与NodePort类似，在每个节点上启用一个端口来暴 露服务。除此之外，Kubernetes会请求底层云平台上的负载均衡器， 将每个Node（[NodeIP]:[NodePort]）作为后端添加进去。</p></li></ul><blockquote><p><strong>ClusterIP的用法</strong></p></blockquote><ul><li><strong>查看deployment</strong></li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get deployment</span>
NAME   READY   UP-TO-DATE   AVAILABLE   AGE
web    <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           71s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>快速生成一个绑定deployment的web的service端口开放</strong></li></ul><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl expose deployment web --port=80 --target-port=80 --type=ClusterIP --dry-run -o yaml  &gt; service.yaml</span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># cat service.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> web
  <span class="token key atrule">name</span><span class="token punctuation">:</span> web
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP			<span class="token comment">#这里是指定类型，默认是ClusterIP</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>				<span class="token comment">#service（负载均衡器）端口，只能再k8s集群内部访问，（node和Pod）</span>
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP			<span class="token comment">#端口的协议</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>			<span class="token comment">#容器中提供服务的端口</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>					<span class="token comment">#标签选择器，用来关联pod</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> web
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>运行service的yaml文件</strong></li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f service.yaml</span>
service/web created

<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get service</span>
NAME         TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>   AGE
kubernetes   ClusterIP   <span class="token number">10.96</span>.0.1      <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP   29h
web          ClusterIP   <span class="token number">10.107</span>.119.3   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">80</span>/TCP    5s
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>访问service的地址</strong></li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># curl 10.107.119.3</span>
<span class="token operator">&lt;</span><span class="token operator">!</span>DOCTYPE html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>Welcome to nginx<span class="token operator">!</span><span class="token operator">&lt;</span>/title<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>style<span class="token operator">&gt;</span>
html <span class="token punctuation">{</span> color-scheme: light dark<span class="token punctuation">;</span> <span class="token punctuation">}</span>
body <span class="token punctuation">{</span> width: 35em<span class="token punctuation">;</span> margin: <span class="token number">0</span> auto<span class="token punctuation">;</span>
font-family: Tahoma, Verdana, Arial, sans-serif<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token operator">&lt;</span>/style<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>Welcome to nginx<span class="token operator">!</span><span class="token operator">&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>
<span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.<span class="token operator">&lt;</span>/p<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>For online documentation and support please refer to
<span class="token operator">&lt;</span>a <span class="token assign-left variable">href</span><span class="token operator">=</span><span class="token string">&quot;http://nginx.org/&quot;</span><span class="token operator">&gt;</span>nginx.org<span class="token operator">&lt;</span>/a<span class="token operator">&gt;</span>.<span class="token operator">&lt;</span>br/<span class="token operator">&gt;</span>
Commercial support is available at
<span class="token operator">&lt;</span>a <span class="token assign-left variable">href</span><span class="token operator">=</span><span class="token string">&quot;http://nginx.com/&quot;</span><span class="token operator">&gt;</span>nginx.com<span class="token operator">&lt;</span>/a<span class="token operator">&gt;</span>.<span class="token operator">&lt;</span>/p<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>p<span class="token operator">&gt;</span><span class="token operator">&lt;</span>em<span class="token operator">&gt;</span>Thank you <span class="token keyword">for</span> using nginx.<span class="token operator">&lt;</span>/em<span class="token operator">&gt;</span><span class="token operator">&lt;</span>/p<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/html<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><strong>NodePort的用法</strong></p></blockquote><ul><li><strong>修改service的端口类型</strong></li></ul><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># cat service.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> web
  <span class="token key atrule">name</span><span class="token punctuation">:</span> web
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort		<span class="token comment">#暴露端口类型用NodePort </span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
     <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">30002</span>     <span class="token comment">#可以指定一个暴露端口，也可以默认生成</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> web
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>查看service更新的端口并且访问</strong></li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get service</span>
NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>        AGE
kubernetes   ClusterIP   <span class="token number">10.96</span>.0.1       <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP        29h
web          NodePort    <span class="token number">10.111</span>.240.72   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">80</span>:30002/TCP   8s

<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># curl 192.168.1.104:30002</span>
<span class="token operator">&lt;</span><span class="token operator">!</span>DOCTYPE html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>Welcome to nginx<span class="token operator">!</span><span class="token operator">&lt;</span>/title<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>style<span class="token operator">&gt;</span>
html <span class="token punctuation">{</span> color-scheme: light dark<span class="token punctuation">;</span> <span class="token punctuation">}</span>
body <span class="token punctuation">{</span> width: 35em<span class="token punctuation">;</span> margin: <span class="token number">0</span> auto<span class="token punctuation">;</span>
font-family: Tahoma, Verdana, Arial, sans-serif<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token operator">&lt;</span>/style<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>Welcome to nginx<span class="token operator">!</span><span class="token operator">&lt;</span>/h<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>
<span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.<span class="token operator">&lt;</span>/p<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>For online documentation and support please refer to
<span class="token operator">&lt;</span>a <span class="token assign-left variable">href</span><span class="token operator">=</span><span class="token string">&quot;http://nginx.org/&quot;</span><span class="token operator">&gt;</span>nginx.org<span class="token operator">&lt;</span>/a<span class="token operator">&gt;</span>.<span class="token operator">&lt;</span>br/<span class="token operator">&gt;</span>
Commercial support is available at
<span class="token operator">&lt;</span>a <span class="token assign-left variable">href</span><span class="token operator">=</span><span class="token string">&quot;http://nginx.com/&quot;</span><span class="token operator">&gt;</span>nginx.com<span class="token operator">&lt;</span>/a<span class="token operator">&gt;</span>.<span class="token operator">&lt;</span>/p<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>p<span class="token operator">&gt;</span><span class="token operator">&lt;</span>em<span class="token operator">&gt;</span>Thank you <span class="token keyword">for</span> using nginx.<span class="token operator">&lt;</span>/em<span class="token operator">&gt;</span><span class="token operator">&lt;</span>/p<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/html<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="service代理模式" tabindex="-1"><a class="header-anchor" href="#service代理模式" aria-hidden="true">#</a> Service代理模式</h3><blockquote><p><strong>Service的几种代理</strong></p></blockquote><ul><li><p><code>userspace</code></p></li><li><p><code>iptables （默认）</code></p></li><li><p><code>ipvs （lvs）</code></p></li></ul><blockquote><p><strong>iptables默认方式</strong></p></blockquote><ul><li><strong>部署一个ClusterIP的方式暴露端口的Pod</strong></li></ul><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># cat service.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> web
  <span class="token key atrule">name</span><span class="token punctuation">:</span> web
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> web
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl apply  -f service.yaml</span>
service/web unchanged

<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl  get service</span>
NAME         TYPE        CLUSTER<span class="token punctuation">-</span>IP      EXTERNAL<span class="token punctuation">-</span>IP   PORT(S)   AGE
kubernetes   ClusterIP   10.96.0.1       &lt;none<span class="token punctuation">&gt;</span>        443/TCP   4h20m
web          ClusterIP   10.101.63.199   &lt;none<span class="token punctuation">&gt;</span>        80/TCP    21m
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>查看默认的iptables代理是怎么实现负载均衡的机制</strong></li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># iptables-save  | grep 10.101.63.199</span>

<span class="token comment">#第一步</span>
<span class="token parameter variable">-A</span> KUBE-SERVICES <span class="token operator">!</span> <span class="token parameter variable">-s</span> <span class="token number">10.244</span>.0.0/16 <span class="token parameter variable">-d</span> <span class="token number">10.101</span>.63.199/32 <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">-m</span> comment <span class="token parameter variable">--comment</span> <span class="token string">&quot;default/web cluster IP&quot;</span> <span class="token parameter variable">-m</span> tcp <span class="token parameter variable">--dport</span> <span class="token number">80</span> <span class="token parameter variable">-j</span> KUBE-MARK-MASQ

<span class="token comment">#第二步</span>
<span class="token parameter variable">-A</span> KUBE-SVC-LOLE4ISW44XBNF3G <span class="token parameter variable">-m</span> comment <span class="token parameter variable">--comment</span> <span class="token string">&quot;default/web&quot;</span> <span class="token parameter variable">-j</span> KUBE-SEP-NBPPORLROMQLLPIL

<span class="token comment">#第三步</span>
<span class="token parameter variable">-A</span> KUBE-SERVICES <span class="token parameter variable">-d</span> <span class="token number">10.101</span>.63.199/32 <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">-m</span> comment <span class="token parameter variable">--comment</span> <span class="token string">&quot;default/web cluster IP&quot;</span> <span class="token parameter variable">-m</span> tcp <span class="token parameter variable">--dport</span> <span class="token number">80</span> <span class="token parameter variable">-j</span> KUBE-SVC-LOLE4ISW44XBNF3G
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>ipvs模式</p></blockquote><p><strong>修改为ipvs模式</strong></p><p><strong>kubeadm方式修改ipvs模式：</strong></p><p><strong>注：</strong></p><ul><li><p><strong>kube-proxy配置文件以configmap方式存储</strong></p></li><li><p><strong>如果让所有节点生效，需要重建所有节点kube-proxy pod</strong></p></li><li><p><strong>修改配置文件删除Pod</strong></p></li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl edit configmaps -n kube-system kube-proxy</span>
···
    mode: <span class="token string">&quot;ipvs&quot;</span>
···

<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete pod -n kube-system kube-proxy-628k6 kube-proxy-7sbfn kube-proxy-jzrxz</span>
pod <span class="token string">&quot;kube-proxy-628k6&quot;</span> deleted
pod <span class="token string">&quot;kube-proxy-7sbfn&quot;</span> deleted
pod <span class="token string">&quot;kube-proxy-jzrxz&quot;</span> deleted
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>查看当前模式</strong></li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl logs -n kube-system kube-proxy-c8vzr | grep ipvs</span>
I1103 09:20:08.747308       <span class="token number">1</span> server_others.go:258<span class="token punctuation">]</span> Using ipvs Proxier.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>安装ipvs工具</strong></li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># yum install -y  ipvsadm</span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># ipvsadm -L -n   </span>
· <span class="token parameter variable">-L</span> 列出所有规则
· <span class="token parameter variable">-n</span> 以非主机名的方式去显示

IP Virtual Server version <span class="token number">1.2</span>.1 <span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">4096</span><span class="token punctuation">)</span>
Prot LocalAddress:Port Scheduler Flags
  -<span class="token operator">&gt;</span> RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  <span class="token number">192.168</span>.1.104:32238 rr
  -<span class="token operator">&gt;</span> <span class="token number">10.244</span>.104.1:80              Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>
TCP  <span class="token number">10.96</span>.0.1:443 rr
  -<span class="token operator">&gt;</span> <span class="token number">192.168</span>.1.104:6443           Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>
TCP  <span class="token number">10.96</span>.0.10:53 rr
  -<span class="token operator">&gt;</span> <span class="token number">10.244</span>.219.66:53             Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>
  -<span class="token operator">&gt;</span> <span class="token number">10.244</span>.219.67:53             Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>
TCP  <span class="token number">10.96</span>.0.10:9153 rr
  -<span class="token operator">&gt;</span> <span class="token number">10.244</span>.219.66:9153           Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>
  -<span class="token operator">&gt;</span> <span class="token number">10.244</span>.219.67:9153           Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>
TCP  <span class="token number">10.101</span>.63.199:80 rr
  -<span class="token operator">&gt;</span> <span class="token number">10.244</span>.104.1:80              Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>
TCP  <span class="token number">10.244</span>.219.64:32238 rr
  -<span class="token operator">&gt;</span> <span class="token number">10.244</span>.104.1:80              Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>
TCP  <span class="token number">127.0</span>.0.1:32238 rr
  -<span class="token operator">&gt;</span> <span class="token number">10.244</span>.104.1:80              Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>
TCP  <span class="token number">172.17</span>.0.1:32238 rr
  -<span class="token operator">&gt;</span> <span class="token number">10.244</span>.104.1:80              Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>
UDP  <span class="token number">10.96</span>.0.10:53 rr
  -<span class="token operator">&gt;</span> <span class="token number">10.244</span>.219.66:53             Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>
  -<span class="token operator">&gt;</span> <span class="token number">10.244</span>.219.67:53             Masq    <span class="token number">1</span>      <span class="token number">0</span>          <span class="token number">0</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ipvs的访问流程：</strong></p><ul><li><strong><code>curl service ip &gt; kube-ipvs0(virtual server) &gt; pod(real server)</code></strong></li><li><code>通过内置的ipvs网卡实现负载的功能</code></li><li><strong><code>IPVS模式下，ingress和service使用相同的ELB实例时，无法在集群内的节点和容器中访问ingress</code></strong></li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token number">9</span>: kube-ipvs0: <span class="token operator">&lt;</span>BROADCAST,NOARP<span class="token operator">&gt;</span> mtu <span class="token number">1500</span> qdisc noop state DOWN group default
    link/ether 2e:a3:33:75:1d:20 brd ff:ff:ff:ff:ff:ff
    inet <span class="token number">10.96</span>.0.1/32 scope global kube-ipvs0
       valid_lft forever preferred_lft forever
    inet <span class="token number">10.96</span>.0.10/32 scope global kube-ipvs0
       valid_lft forever preferred_lft forever
    inet <span class="token number">10.101</span>.63.199/32 scope global kube-ipvs0
       valid_lft forever preferred_lft forever
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p><strong>Iptables VS IPVS</strong></p></blockquote><p><strong>Iptables：</strong></p><ul><li><p><code>灵活，功能强大</code></p></li><li><p><code>规则遍历匹配和更新，呈线性时延</code></p></li></ul><p><strong>IPVS：</strong></p><ul><li><p><code>工作在内核态，有更好的性能</code></p></li><li><p><code>调度算法丰富：rr，wrr，lc，wlc，ip hash..</code></p></li></ul><h3 id="service-dns名称" tabindex="-1"><a class="header-anchor" href="#service-dns名称" aria-hidden="true">#</a> Service DNS名称</h3><blockquote><p><strong>CoreDNS：</strong></p><p>是一个DNS服务器，Kubernetes默认采用，以Pod部署在集群中，CoreDNS服 务监视Kubernetes API，为每一个Service创建DNS记录用于域名解析。</p></blockquote><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>CoreDNS YAML文件：
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># wget https://github.com/kubernetes/kubernetes/tree/master/cluster/addons/dns/coredns  </span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>ClusterIP A记录格式：<span class="token operator">&lt;</span>service-name<span class="token operator">&gt;</span>.<span class="token operator">&lt;</span>namespace-name<span class="token operator">&gt;</span>.svc.cluster.local
示例：my-svc.my-namespace.svc.cluster.local
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>运行一个容器用来解析k8s集群的域名</strong></li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl run -it --rm --image=busybox:1.28.4 -- sh</span>

If you don&#39;t see a <span class="token builtin class-name">command</span> prompt, try pressing enter.

/ <span class="token comment"># nslookup</span>

<span class="token comment">#查看一下service的custer—ip</span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get service</span>
NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>        AGE
kubernetes   ClusterIP   <span class="token number">10.96</span>.0.1       <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP        4h58m
web          NodePort    <span class="token number">10.101</span>.63.199   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">80</span>:32238/TCP   59m
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>解析一下clusterip</strong></li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>BusyBox v1.28.4 <span class="token punctuation">(</span><span class="token number">2018</span>-05-22 <span class="token number">17</span>:00:17 UTC<span class="token punctuation">)</span> multi-call binary.
Usage: <span class="token function">nslookup</span> <span class="token punctuation">[</span>HOST<span class="token punctuation">]</span> <span class="token punctuation">[</span>SERVER<span class="token punctuation">]</span>

Query the nameserver <span class="token keyword">for</span> the IP address of the given HOST
optionally using a specified DNS server
/ <span class="token comment"># nslookup 10.101.63.199</span>
Server:    <span class="token number">10.96</span>.0.10
Address <span class="token number">1</span>: <span class="token number">10.96</span>.0.10 kube-dns.kube-system.svc.cluster.local

Name:      <span class="token number">10.101</span>.63.199
Address <span class="token number">1</span>: <span class="token number">10.101</span>.63.199 web.default.svc.cluster.local
/ <span class="token comment">#</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="ingress" tabindex="-1"><a class="header-anchor" href="#ingress" aria-hidden="true">#</a> Ingress</h2><h3 id="ingress为弥补nodeport不足而生" tabindex="-1"><a class="header-anchor" href="#ingress为弥补nodeport不足而生" aria-hidden="true">#</a> Ingress为弥补NodePort不足而生</h3><p><strong>NodePort存在的不足：</strong></p><ul><li><p>一个端口只能一个服务使用，端口需提前规划</p></li><li><p>只支持4层负载均衡</p></li></ul><blockquote><p><strong>Ingress是什么？</strong></p><ul><li><p>Ingress：Ingress公开了从集群外部到集群内服务的HTTP和HTTPS路由的规则集合，而具体实现流量路 由则是由Ingress Controller负责。</p></li><li><p>Ingress：K8s中的一个抽象资源，给管理员 提供一个暴露应用的入口定义方法</p></li><li><p>Ingress Controller：根据Ingress生成具体 的路由规则，并对Pod负载均衡器</p></li></ul><p><strong>Ingress是授权入站连接到达集群服务的规则集合。</strong></p><ul><li>从外部流量调度到nodeprot上的service</li><li>从service调度到ingress-controller</li><li>ingress-controller根据ingress中的定义（虚拟主机或者后端的url）</li><li>根据虚拟主机名调度到后端的一组pod中</li></ul></blockquote><blockquote><p><strong>Ingress Controller是什么？</strong></p><p>Ingress管理的负载均衡器，为集群提供全局的负载均衡能力。</p><p><strong>使用流程：</strong></p><ol><li>部署Ingress Controller</li><li>创建Ingress规则</li></ol></blockquote><h3 id="ingress-controller" tabindex="-1"><a class="header-anchor" href="#ingress-controller" aria-hidden="true">#</a> Ingress Controller</h3><ul><li><p><strong>Ingress 不会公开任意端口或协议。 将 HTTP 和 HTTPS 以外的服务公开到 Internet 时，通常使用 <a href="https://kubernetes.io/zh/docs/concepts/services-networking/service/#nodeport" target="_blank" rel="noopener noreferrer">Service.Type=NodePort<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 或 <a href="https://kubernetes.io/zh/docs/concepts/services-networking/service/#loadbalancer" target="_blank" rel="noopener noreferrer">Service.Type=LoadBalancer<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 类型的服务。</strong></p></li><li><p>Ingress Controller有很多实现，我们这里采用官方维护的Nginx控制器。</p></li><li><p>项目地址：<a href="https://github.com/kubernetes/ingress-nginx" target="_blank" rel="noopener noreferrer">https://github.com/kubernetes/ingress-nginx<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></li></ul><p><strong>修改YAML：</strong></p><ul><li><code>镜像地址修改成国内的：lizhenliang/nginx-ingress-controller:0.30.0</code></li><li><code>将Ingress Controller暴露，一般使用宿主机网络（hostNetwork: true）或者使用NodePort</code></li></ul><h3 id="环境准备" tabindex="-1"><a class="header-anchor" href="#环境准备" aria-hidden="true">#</a> 环境准备</h3><ul><li><p>你必须具有 <a href="https://kubernetes.io/zh/docs/concepts/services-networking/ingress-controllers" target="_blank" rel="noopener noreferrer">Ingress 控制器<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 才能满足 Ingress 的要求。 仅创建 Ingress 资源本身没有任何效果。</p></li><li><p>你可能需要部署 Ingress 控制器，例如 <a href="https://kubernetes.github.io/ingress-nginx/deploy/" target="_blank" rel="noopener noreferrer">ingress-nginx<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>。 你可以从许多 <a href="https://kubernetes.io/zh/docs/concepts/services-networking/ingress-controllers" target="_blank" rel="noopener noreferrer">Ingress 控制器<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 中进行选择。</p></li><li><p>理想情况下，所有 Ingress 控制器都应符合参考规范。但实际上，不同的 Ingress 控制器操作略有不同。</p></li><li><p><strong>初始化Ingress的控制器</strong></p></li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f  ingress-controller.yaml</span>
namespace/ingress-nginx unchanged
configmap/nginx-configuration unchanged
configmap/tcp-services unchanged
configmap/udp-services unchanged
serviceaccount/nginx-ingress-serviceaccount unchanged
Warning: rbac.authorization.k8s.io/v1beta1 ClusterRole is deprecated <span class="token keyword">in</span> v1.17+, unavailable <span class="token keyword">in</span> v1.22+<span class="token punctuation">;</span> use rbac.authorization.k8s.io/v1 ClusterRole
clusterrole.rbac.authorization.k8s.io/nginx-ingress-clusterrole unchanged
Warning: rbac.authorization.k8s.io/v1beta1 Role is deprecated <span class="token keyword">in</span> v1.17+, unavailable <span class="token keyword">in</span> v1.22+<span class="token punctuation">;</span> use rbac.authorization.k8s.io/v1 Role
role.rbac.authorization.k8s.io/nginx-ingress-role unchanged
Warning: rbac.authorization.k8s.io/v1beta1 RoleBinding is deprecated <span class="token keyword">in</span> v1.17+, unavailable <span class="token keyword">in</span> v1.22+<span class="token punctuation">;</span> use rbac.authorization.k8s.io/v1 RoleBinding
rolebinding.rbac.authorization.k8s.io/nginx-ingress-role-nisa-binding unchanged
Warning: rbac.authorization.k8s.io/v1beta1 ClusterRoleBinding is deprecated <span class="token keyword">in</span> v1.17+, unavailable <span class="token keyword">in</span> v1.22+<span class="token punctuation">;</span> use rbac.authorization.k8s.io/v1 ClusterRoleBinding
clusterrolebinding.rbac.authorization.k8s.io/nginx-ingress-clusterrole-nisa-binding unchanged
daemonset.apps/nginx-ingress-controller unchanged
limitrange/ingress-nginx configured
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>使用命名空间隔离资源，创建deployment和service</strong></li></ul><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># cat nginx.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Namespace
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>test<span class="token punctuation">-</span>ns
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>test<span class="token punctuation">-</span>ns
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>test<span class="token punctuation">-</span>ns
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort
  
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f  nginx.yaml</span>
namespace/web<span class="token punctuation">-</span>test<span class="token punctuation">-</span>ns created
deployment.apps/nginx created
service/nginx created

<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get deployment -n web-test-ns</span>
NAME    READY   UP<span class="token punctuation">-</span>TO<span class="token punctuation">-</span>DATE   AVAILABLE   AGE
nginx   1/1     1            1           30m
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get service</span>
NAME         TYPE        CLUSTER<span class="token punctuation">-</span>IP    EXTERNAL<span class="token punctuation">-</span>IP   PORT(S)        AGE
kubernetes   ClusterIP   10.96.0.1     &lt;none<span class="token punctuation">&gt;</span>        443/TCP        8h
nginx        NodePort    10.106.56.3   &lt;none<span class="token punctuation">&gt;</span>        80<span class="token punctuation">:</span>31410/TCP   30m
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="ingress-1" tabindex="-1"><a class="header-anchor" href="#ingress-1" aria-hidden="true">#</a> Ingress</h3><ul><li><p><strong>ingress可以给service提供集群外部访问的url、负载均衡、ssl终止、http路由等。</strong></p></li><li><p><strong>为了配置这些ingress规则，集群管理员需要部署一个ingress controller，它监听ingress和service的变化，根据规则配置负载均衡并提供访问入口</strong></p></li><li><p><strong>创建一个最小资源化的Ingress</strong></p></li></ul><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span>$ kubectl create ingress ingsecret <span class="token punctuation">-</span><span class="token punctuation">-</span>class=default <span class="token punctuation">-</span><span class="token punctuation">-</span>rule=&quot;/<span class="token important">*=nginx:80&quot;</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>dry<span class="token punctuation">-</span>run <span class="token punctuation">-</span>o yaml <span class="token punctuation">&gt;</span> ingress.yaml
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># cat ingress2.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span>  networking.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>web
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>test<span class="token punctuation">-</span>ns  
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>					<span class="token comment">#创建一个规则</span>
  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> test.com			<span class="token comment">#指定主机的域名</span>
    <span class="token key atrule">http</span><span class="token punctuation">:</span>					
      <span class="token key atrule">paths</span><span class="token punctuation">:</span>				<span class="token comment">#将请求映射到后端的路径集合</span>
      <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /  
        <span class="token key atrule">pathType</span><span class="token punctuation">:</span> Prefix
        <span class="token key atrule">backend</span><span class="token punctuation">:</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx		<span class="token comment">#service的名称</span>
          <span class="token key atrule">port</span><span class="token punctuation">:</span> 
            <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>      <span class="token comment">#service的端口</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>创建ingress查看ingress的状态</strong></li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f  ingress2.yaml</span>
Warning: extensions/v1beta1 Ingress is deprecated <span class="token keyword">in</span> v1.14+, unavailable <span class="token keyword">in</span> v1.22+<span class="token punctuation">;</span> use networking.k8s.io/v1 Ingress
ingress.extensions/ingress-web configured

<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get ingress -n web-test-ns</span>
NAME          CLASS    HOSTS      ADDRESS   PORTS   AGE
ingress-web   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   test.com             <span class="token number">80</span>      28m
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>Ingress control的入口地址是什么？怎么访问呢？</strong></li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -A  -o wide   </span>
NAMESPACE       NAME                                       READY   STATUS    RESTARTS   AGE     IP              NODE     NOMINATED NODE   READINESS GATES
ingress-nginx   nginx-ingress-controller-26w7m             <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3h25m   <span class="token number">192.168</span>.1.121   node2    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
ingress-nginx   nginx-ingress-controller-9bm8d             <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3h25m   <span class="token number">192.168</span>.1.120   node1    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
···
web-test-ns     nginx-7848d4b86f-v27pj                     <span class="token number">1</span>/1     Running   <span class="token number">0</span>          39m     <span class="token number">10.244</span>.104.2    node2    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>

<span class="token comment">#192.168.1.121就是访问地址</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>在本地的hosts配置映射</strong></li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>C:<span class="token punctuation">\</span>Windows<span class="token punctuation">\</span>System32<span class="token punctuation">\</span>drivers<span class="token punctuation">\</span>etc

<span class="token number">192.168</span>.1.121 test.com


C:<span class="token punctuation">\</span>Users<span class="token punctuation">\</span>zyh<span class="token operator">&gt;</span>ping test.com

正在 Ping test.com <span class="token punctuation">[</span><span class="token number">192.168</span>.1.121<span class="token punctuation">]</span> 具有 <span class="token number">32</span> 字节的数据:
来自 <span class="token number">192.168</span>.1.121 的回复: 字节<span class="token operator">=</span><span class="token number">32</span> 时间<span class="token operator">&lt;</span>1ms <span class="token assign-left variable">TTL</span><span class="token operator">=</span><span class="token number">64</span>
来自 <span class="token number">192.168</span>.1.121 的回复: 字节<span class="token operator">=</span><span class="token number">32</span> 时间<span class="token operator">&lt;</span>1ms <span class="token assign-left variable">TTL</span><span class="token operator">=</span><span class="token number">64</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p><strong>然后可以在网站上用域名访问，可以访问到，然后查看两个node节点的端口开放</strong></p></li><li><p><strong>masetr节点的端口并没发现有80和443端口</strong></p></li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># ss -anpt | grep 80</span>
LISTEN     <span class="token number">0</span>      <span class="token number">128</span>    <span class="token number">192.168</span>.1.104:2380                     *:*                   users:<span class="token variable"><span class="token punctuation">((</span>&quot;etcd&quot;<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">10511</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">))</span></span>
ESTAB      <span class="token number">0</span>      <span class="token number">0</span>      <span class="token number">127.0</span>.0.1:2379               <span class="token number">127.0</span>.0.1:47360               users:<span class="token variable"><span class="token punctuation">((</span>&quot;etcd&quot;<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">10511</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">80</span><span class="token punctuation">))</span></span>
ESTAB      <span class="token number">0</span>      <span class="token number">0</span>      <span class="token number">127.0</span>.0.1:2379               <span class="token number">127.0</span>.0.1:47280               users:<span class="token variable"><span class="token punctuation">((</span>&quot;etcd&quot;<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">10511</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">))</span></span>
TIME-WAIT  <span class="token number">0</span>      <span class="token number">0</span>      <span class="token number">192.168</span>.1.104:46336              <span class="token number">10.244</span>.219.69:8080
ESTAB      <span class="token number">0</span>      <span class="token number">0</span>      <span class="token number">127.0</span>.0.1:47280              <span class="token number">127.0</span>.0.1:2379                users:<span class="token variable"><span class="token punctuation">((</span>&quot;kube<span class="token operator">-</span>apiserver&quot;<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">10492</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">34</span><span class="token punctuation">))</span></span>
TIME-WAIT  <span class="token number">0</span>      <span class="token number">0</span>      <span class="token number">192.168</span>.1.104:46254              <span class="token number">10.244</span>.219.69:8080
ESTAB      <span class="token number">0</span>      <span class="token number">0</span>      <span class="token number">127.0</span>.0.1:47376              <span class="token number">127.0</span>.0.1:2379                users:<span class="token variable"><span class="token punctuation">((</span>&quot;kube<span class="token operator">-</span>apiserver&quot;<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">10492</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">80</span><span class="token punctuation">))</span></span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># ss -anpt | grep 443</span>
ESTAB      <span class="token number">0</span>      <span class="token number">0</span>      <span class="token number">192.168</span>.1.104:49890              <span class="token number">192.168</span>.1.104:6443                users:<span class="token variable"><span class="token punctuation">((</span>&quot;kubelet&quot;<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">906</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">45</span><span class="token punctuation">))</span></span>
ESTAB      <span class="token number">0</span>      <span class="token number">0</span>      <span class="token number">10.96</span>.0.1:33866              <span class="token number">10.96</span>.0.1:443                 users:<span class="token variable"><span class="token punctuation">((</span>&quot;calico<span class="token operator">-</span>node&quot;<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">13259</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">))</span></span>
ESTAB      <span class="token number">0</span>      <span class="token number">0</span>      <span class="token number">192.168</span>.1.104:50300              <span class="token number">192.168</span>.1.104:6443                users:<span class="token variable"><span class="token punctuation">((</span>&quot;kube<span class="token operator">-</span>controller&quot;<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">10462</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">))</span></span>
ESTAB      <span class="token number">0</span>      <span class="token number">0</span>      <span class="token number">192.168</span>.1.104:50150              <span class="token number">192.168</span>.1.104:6443                users:<span class="token variable"><span class="token punctuation">((</span>&quot;kube<span class="token operator">-</span>proxy&quot;<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">12370</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">))</span></span>
ESTAB      <span class="token number">0</span>      <span class="token number">0</span>      <span class="token number">10.96</span>.0.1:33860              <span class="token number">10.96</span>.0.1:443                 users:<span class="token variable"><span class="token punctuation">((</span>&quot;calico<span class="token operator">-</span>node&quot;<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">13257</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">))</span></span>
ESTAB      <span class="token number">0</span>      <span class="token number">0</span>      <span class="token number">192.168</span>.1.104:49906              <span class="token number">192.168</span>.1.104:6443                users:<span class="token variable"><span class="token punctuation">((</span>&quot;kube<span class="token operator">-</span>controller&quot;<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">10462</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">9</span><span class="token punctuation">))</span></span>
ESTAB      <span class="token number">0</span>      <span class="token number">0</span>      <span class="token number">192.168</span>.1.104:50118              <span class="token number">192.168</span>.1.104:6443                users:<span class="token variable"><span class="token punctuation">((</span>&quot;kube<span class="token operator">-</span>scheduler&quot;<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">10479</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">))</span></span>
ESTAB      <span class="token number">0</span>      <span class="token number">0</span>      <span class="token number">10.96</span>.0.1:33864              <span class="token number">10.96</span>.0.1:443                 users:<span class="token variable"><span class="token punctuation">((</span>&quot;calico<span class="token operator">-</span>node&quot;<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">13261</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">))</span></span>
ESTAB      <span class="token number">0</span>      <span class="token number">0</span>      <span class="token number">192.168</span>.1.104:49888              <span class="token number">192.168</span>.1.104:6443                users:<span class="token variable"><span class="token punctuation">((</span>&quot;kube<span class="token operator">-</span>scheduler&quot;<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">10479</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">9</span><span class="token punctuation">))</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p><strong><code>此时查看两个node节点发现80端口和443端口开放</code></strong></p></li><li><p><strong>说明负载的作用成功了，ingress正常</strong></p></li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># ss -anpt  | grep 80</span>
LISTEN     <span class="token number">0</span>      <span class="token number">128</span>          *:80                       *:*                   users:<span class="token variable"><span class="token punctuation">((</span>&quot;nginx&quot;<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">20388</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">33</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>&quot;nginx&quot;<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">13765</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">33</span><span class="token punctuation">))</span></span>
LISTEN     <span class="token number">0</span>      <span class="token number">128</span>          *:80                       *:*                   users:<span class="token variable"><span class="token punctuation">((</span>&quot;nginx&quot;<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">20388</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>&quot;nginx&quot;<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">13764</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">))</span></span>
LISTEN     <span class="token number">0</span>      <span class="token number">128</span>          *:80                       *:*                   users:<span class="token variable"><span class="token punctuation">((</span>&quot;nginx&quot;<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">20388</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">31</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>&quot;nginx&quot;<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">13763</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">31</span><span class="token punctuation">))</span></span>
LISTEN     <span class="token number">0</span>      <span class="token number">128</span>          *:80                       *:*                   users:<span class="token variable"><span class="token punctuation">((</span>&quot;nginx&quot;<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">20388</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">23</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>&quot;nginx&quot;<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">13762</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">23</span><span class="token punctuation">))</span></span>
TIME-WAIT  <span class="token number">0</span>      <span class="token number">0</span>      <span class="token number">127.0</span>.0.1:36780              <span class="token number">127.0</span>.0.1:9099
TIME-WAIT  <span class="token number">0</span>      <span class="token number">0</span>      <span class="token number">127.0</span>.0.1:36804              <span class="token number">127.0</span>.0.1:9099
TIME-WAIT  <span class="token number">0</span>      <span class="token number">0</span>      <span class="token number">127.0</span>.0.1:36800              <span class="token number">127.0</span>.0.1:9099

<span class="token punctuation">[</span>root@node1 ~<span class="token punctuation">]</span><span class="token comment"># ss -anpt  | grep  443</span>
LISTEN     <span class="token number">0</span>      <span class="token number">128</span>          *:443                      *:*                   users:<span class="token variable"><span class="token punctuation">((</span>&quot;nginx&quot;<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">20388</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">39</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>&quot;nginx&quot;<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">13765</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">39</span><span class="token punctuation">))</span></span>
LISTEN     <span class="token number">0</span>      <span class="token number">128</span>          *:443                      *:*                   users:<span class="token variable"><span class="token punctuation">((</span>&quot;nginx&quot;<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">20388</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">38</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>&quot;nginx&quot;<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">13764</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">38</span><span class="token punctuation">))</span></span>
LISTEN     <span class="token number">0</span>      <span class="token number">128</span>          *:443                      *:*                   users:<span class="token variable"><span class="token punctuation">((</span>&quot;nginx&quot;<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">20388</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">37</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>&quot;nginx&quot;<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">13763</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">37</span><span class="token punctuation">))</span></span>
LISTEN     <span class="token number">0</span>      <span class="token number">128</span>          *:443                      *:*                   users:<span class="token variable"><span class="token punctuation">((</span>&quot;nginx&quot;<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">20388</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span>&quot;nginx&quot;<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">13762</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">25</span><span class="token punctuation">))</span></span>
ESTAB      <span class="token number">0</span>      <span class="token number">0</span>      <span class="token number">10.96</span>.0.1:54834              <span class="token number">10.96</span>.0.1:443                 users:<span class="token variable"><span class="token punctuation">((</span>&quot;calico<span class="token operator">-</span>node&quot;<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">14921</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">9</span><span class="token punctuation">))</span></span>
ESTAB      <span class="token number">0</span>      <span class="token number">0</span>      <span class="token number">10.96</span>.0.1:54928              <span class="token number">10.96</span>.0.1:443                 users:<span class="token variable"><span class="token punctuation">((</span>&quot;nginx<span class="token operator">-</span>ingress<span class="token operator">-</span>c&quot;<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">20287</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">24</span><span class="token punctuation">))</span></span>
ESTAB      <span class="token number">0</span>      <span class="token number">0</span>      <span class="token number">192.168</span>.1.120:44100              <span class="token number">192.168</span>.1.104:6443                users:<span class="token variable"><span class="token punctuation">((</span>&quot;kubelet&quot;<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">13313</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">))</span></span>
ESTAB      <span class="token number">0</span>      <span class="token number">0</span>      <span class="token number">10.96</span>.0.1:54820              <span class="token number">10.96</span>.0.1:443                 users:<span class="token variable"><span class="token punctuation">((</span>&quot;calico<span class="token operator">-</span>node&quot;<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">14916</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">))</span></span>
ESTAB      <span class="token number">0</span>      <span class="token number">0</span>      <span class="token number">10.96</span>.0.1:54822              <span class="token number">10.96</span>.0.1:443                 users:<span class="token variable"><span class="token punctuation">((</span>&quot;calico<span class="token operator">-</span>node&quot;<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">14918</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">))</span></span>
ESTAB      <span class="token number">0</span>      <span class="token number">0</span>      <span class="token number">192.168</span>.1.120:44166              <span class="token number">192.168</span>.1.104:6443                users:<span class="token variable"><span class="token punctuation">((</span>&quot;kube<span class="token operator">-</span>proxy&quot;<span class="token punctuation">,</span>pid<span class="token operator">=</span><span class="token number">8637</span><span class="token punctuation">,</span>fd<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">))</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="ingress配置https的加密认证" tabindex="-1"><a class="header-anchor" href="#ingress配置https的加密认证" aria-hidden="true">#</a> Ingress配置https的加密认证</h3><blockquote><p><strong>Ingress | Https</strong></p></blockquote><ul><li><p><strong>配置HTTPS步骤：</strong></p></li><li><p><strong>准备域名证书文件（来自：openssl/cfssl工具自签或者权威机构颁发）</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># tar -zxvf cfssl.tar.gz  -C /usr/local/bin/</span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># chmod +x certs.sh </span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># ./certs.sh</span>
<span class="token number">2021</span>/11/04 <span class="token number">11</span>:21:17 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generating a new CA key and certificate from CSR
<span class="token number">2021</span>/11/04 <span class="token number">11</span>:21:17 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generate received request
<span class="token number">2021</span>/11/04 <span class="token number">11</span>:21:17 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> received CSR
<span class="token number">2021</span>/11/04 <span class="token number">11</span>:21:17 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generating key: rsa-2048
<span class="token number">2021</span>/11/04 <span class="token number">11</span>:21:18 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> encoded CSR
<span class="token number">2021</span>/11/04 <span class="token number">11</span>:21:18 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> signed certificate with serial number <span class="token number">122465585755296665714458411579230792812069987507</span>
<span class="token number">2021</span>/11/04 <span class="token number">11</span>:21:18 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generate received request
<span class="token number">2021</span>/11/04 <span class="token number">11</span>:21:18 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> received CSR
<span class="token number">2021</span>/11/04 <span class="token number">11</span>:21:18 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> generating key: rsa-2048
<span class="token number">2021</span>/11/04 <span class="token number">11</span>:21:18 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> encoded CSR
<span class="token number">2021</span>/11/04 <span class="token number">11</span>:21:18 <span class="token punctuation">[</span>INFO<span class="token punctuation">]</span> signed certificate with serial number <span class="token number">552651333045426922300417138573432468469848830218</span>
<span class="token number">2021</span>/11/04 <span class="token number">11</span>:21:18 <span class="token punctuation">[</span>WARNING<span class="token punctuation">]</span> This certificate lacks a <span class="token string">&quot;hosts&quot;</span> field. This makes it unsuitable <span class="token keyword">for</span>
websites. For <span class="token function">more</span> information see the Baseline Requirements <span class="token keyword">for</span> the Issuance and Management
of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum <span class="token punctuation">(</span>https://cabforum.org<span class="token punctuation">)</span><span class="token punctuation">;</span>
specifically, section <span class="token number">10.2</span>.3 <span class="token punctuation">(</span><span class="token string">&quot;Information Requirements&quot;</span><span class="token punctuation">)</span>.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>将证书文件保存到Secret kubectl create secret tls web-aliangedu-cn -- cert=web.aliangedu.cn.pem --key=web.aliangedu.cn-key.pem</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl create secret tls web-aliangedu-cn --cert=web.aliangedu.cn.pem --key=web.aliangedu.cn-key.pem</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p><strong>Ingress规则配置tls</strong></p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># cat ingress.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> aliangedu<span class="token punctuation">-</span>https
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>test<span class="token punctuation">-</span>ns
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">tls</span><span class="token punctuation">:</span>							<span class="token comment">#TLS配置</span>
  <span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span>						<span class="token comment">#tls里包含的主机列表</span>
    <span class="token punctuation">-</span> web.aliangedu.cn
    <span class="token key atrule">secretName</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>aliangedu<span class="token punctuation">-</span>cn	<span class="token comment">#TLS通信的密码的名称</span>
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> web.aliangedu.cn
    <span class="token key atrule">http</span><span class="token punctuation">:</span>
      <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /
        <span class="token key atrule">pathType</span><span class="token punctuation">:</span> Prefix
        <span class="token key atrule">backend</span><span class="token punctuation">:</span>
          <span class="token key atrule">service</span><span class="token punctuation">:</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
            <span class="token key atrule">port</span><span class="token punctuation">:</span>
              <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
              
<span class="token punctuation">[</span>root@master work<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f ingress.yaml</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>查看ingress，配置本机的域名映射就可以访问</strong></p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@master work<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -A -o wide</span>
NAMESPACE       NAME                                       READY   STATUS    RESTARTS   AGE   IP               NODE     NOMINATED NODE   READINESS GATES
default         web-5b87848979-l6zjz                       <span class="token number">1</span>/1     Running   <span class="token number">0</span>          9h    <span class="token number">10.244</span>.104.10    node2    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
ingress-nginx   nginx-ingress-controller-26w7m             <span class="token number">1</span>/1     Running   <span class="token number">0</span>          17h   <span class="token number">192.168</span>.1.121    node2    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
ingress-nginx   nginx-ingress-controller-9bm8d             <span class="token number">1</span>/1     Running   <span class="token number">0</span>          17h   <span class="token number">192.168</span>.1.120    node1    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
···
web-test-ns     nginx-6799fc88d8-6ccsk                     <span class="token number">1</span>/1     Running   <span class="token number">0</span>          24m   <span class="token number">10.244</span>.104.11    node2    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>

<span class="token punctuation">[</span>root@master work<span class="token punctuation">]</span><span class="token comment"># kubectl get ingress -n web-test-ns</span>
NAME              CLASS    HOSTS              ADDRESS   PORTS     AGE
aliangedu-https   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   web.aliangedu.cn             <span class="token number">80</span>, <span class="token number">443</span>   24m
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/vuepress-theme-hope/vuepress-theme-hope/edit/main/demo/theme-docs/src/zh/isKcount/2/CKA/08.Kubernetes网络.md" rel="noopener noreferrer" target="_blank" aria-label="在 GitHub 上编辑此页" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->在 GitHub 上编辑此页<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item update-time"><span class="label">上次编辑于: </span><!----></div><div class="meta-item contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: admin@example.com">Administrator</span><!--]--><!--]--></div></footer><!----><!----><!----><!--]--></main><!--]--><footer class="footer-wrapper"><div class="footer">默认页脚</div><div class="copyright">Copyright © 2022 isKcount</div></footer><!--]--></div><!--]--><!----><!----><!--]--></div>
    <script type="module" src="/assets/app.85823306.js" defer></script>
  </body>
</html>
